# GPU Quota & Billing CronJobs
# These jobs manage the billing system's periodic operations
#
# Jobs:
# 1. quota-check: Check tenant quotas every minute, update quota_exceeded
# 2. hourly-aggregate: Aggregate ticks into hourly records
# 3. tick-cleanup: Delete old tick records (older than 7 days)

# CronJob: quota-check - runs every minute
# Checks tenant balances and updates quota_exceeded in etcd via gateway API
apiVersion: batch/v1
kind: CronJob
metadata:
  name: billing-quota-check
spec:
  schedule: "* * * * *"  # Every minute
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: quota-check
              image: inferx/inferx_util:v0.1.0
              command:
                - /bin/sh
                - -c
                - |
                  sh /scripts/quota-check.sh
              env:
                - name: PGHOST
                  value: billingdb
                - name: PGPORT
                  value: "5432"
                - name: PGUSER
                  value: billing_user
                - name: PGPASSWORD
                  value: "123456"
                - name: PGDATABASE
                  value: billingdb
                - name: GATEWAY_URL
                  value: "http://gateway:4000"
                - name: API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: billing-secrets
                      key: api-key
              volumeMounts:
                - name: sql-scripts
                  mountPath: /scripts
          volumes:
            - name: sql-scripts
              configMap:
                name: billing-sql-scripts

---
# # CronJob: hourly-aggregate - runs at minute 5 of every hour
apiVersion: batch/v1
kind: CronJob
metadata:
  name: billing-hourly-aggregate
spec:
  schedule: "5 * * * *"  # At minute 5 of every hour
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: hourly-aggregate
              image: inferx/inferx_util:v0.1.0
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  psql -f /scripts/hourly-aggregate.sql
              env:
                - name: PGHOST
                  value: billingdb
                - name: PGPORT
                  value: "5432"
                - name: PGUSER
                  value: billing_user
                - name: PGPASSWORD
                  value: "123456"
                - name: PGDATABASE
                  value: billingdb
              volumeMounts:
                - name: sql-scripts
                  mountPath: /scripts
          volumes:
            - name: sql-scripts
              configMap:
                name: billing-sql-scripts

# ---
# # CronJob: tick-cleanup - runs daily at 3am
# apiVersion: batch/v1
# kind: CronJob
# metadata:
#   name: billing-tick-cleanup
# spec:
#   schedule: "0 3 * * *"  # Daily at 3:00 AM
#   concurrencyPolicy: Forbid
#   successfulJobsHistoryLimit: 3
#   failedJobsHistoryLimit: 3
#   jobTemplate:
#     spec:
#       template:
#         spec:
#           restartPolicy: OnFailure
#           containers:
#             - name: tick-cleanup
#               image: postgres:15-alpine
#               command:
#                 - /bin/sh
#                 - -c
#                 - |
#                   psql -f /scripts/tick-cleanup.sql
#               env:
#                 - name: PGHOST
#                   value: db
#                 - name: PGPORT
#                   value: "5432"
#                 - name: PGUSER
#                   value: audit_user
#                 - name: PGPASSWORD
#                   value: "123456"
#                 - name: PGDATABASE
#                   value: auditdb
#               volumeMounts:
#                 - name: sql-scripts
#                   mountPath: /scripts
#           volumes:
#             - name: sql-scripts
#               configMap:
#                 name: billing-sql-scripts
