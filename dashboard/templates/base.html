<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title> InferX | Serverless Inference Platform </title>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: #334155;
        }

        nav {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px 10px;
            margin: 0 0 6px 0;
        }

        nav a {
            color: #d64161;
            font-size: clamp(19px, 1.7vw, 24px);
            font-weight: 600;
            line-height: 1.2;
            margin-left: 0;
            padding: 4px 8px;
            border-radius: 4px;
            text-decoration: none;
            white-space: nowrap;
        }

        nav a:hover {
            background: #fff1f2;
        }

        nav a.active {
            background: #d64161;
            color: #ffffff;
        }

        nav a.active:hover {
            background: #c22f50;
        }

        nav a.nav-support-link {
            margin-left: auto;
            min-height: 34px;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            background: transparent;
            color: #1e40af;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            line-height: 1.1;
            position: relative;
        }

        nav a.nav-support-link:hover {
            background: #f1f5f9;
            color: #1e40af;
        }

        nav a.nav-support-link:focus-visible {
            outline: 2px solid #93c5fd;
            outline-offset: 2px;
        }

        nav a.nav-support-link .nav-support-text {
            display: inline-block;
        }

        nav a.nav-support-link .nav-support-icon {
            width: 18px;
            height: 18px;
            display: none;
        }

        nav a.nav-support-link::after {
            content: none;
            position: absolute;
            right: 0;
            top: calc(100% + 8px);
            padding: 5px 8px;
            border-radius: 4px;
            background: #0f172a;
            color: #f8fafc;
            font-size: 12px;
            font-weight: 600;
            line-height: 1.2;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transform: translateY(-2px);
            transition: opacity 120ms ease, transform 120ms ease;
            z-index: 1200;
        }

        nav a.nav-support-link:hover::after,
        nav a.nav-support-link:focus-visible::after {
            opacity: 1;
            transform: translateY(0);
        }

        .nav-divider {
            border: 0;
            border-top: 1px solid #d7dee8;
            margin: 6px 0 10px 0;
        }

        .content table.ix-table {
            border-collapse: collapse;
            background: #fff;
            table-layout: fixed;
        }

        .content table.ix-table th,
        .content table.ix-table td {
            border: 1px solid #aebfd1;
            padding: 10px 12px;
            text-align: center;
            vertical-align: middle;
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .content table.ix-table a {
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .content table.ix-table th {
            background: #f8fafc;
            color: #334155;
            font-weight: 600;
        }

        .content table.ix-table tbody tr:nth-child(odd) {
            background: #ffffff;
        }

        .content table.ix-table tbody tr:nth-child(even) {
            background: #edf3fb;
        }

        .content table.ix-table tbody tr:hover {
            background: #e2ecf9;
        }

        .content table.ix-table.ix-table-compact th,
        .content table.ix-table.ix-table-compact td {
            padding: 4px 6px;
        }

        .audit {
            padding: 20px;
            margin: 10px;
            background-color: #f7f4f4;
        }

        .review {
            margin-left: 50px;
            font-size: 20px;
        }

        .brand-header {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            table-layout: fixed;
            background: #475569;
            border: 1px solid #64748b;
            border-radius: 2px;
            margin-bottom: 10px;
        }

        .brand-header td {
            border: none;
            padding: 5px 10px;
            vertical-align: middle;
        }

        .brand-logo-cell {
            width: 70px;
            text-align: center;
            background: rgba(15, 23, 42, 0.14);
        }

        .brand-logo {
            display: block;
            margin: 0 auto;
        }

        .brand-title-cell {
            width: auto;
        }

        .brand-header h1 {
            margin: 0;
            color: #f8fafc;
            font-size: clamp(16px, 1.9vw, 25px);
            line-height: 1.1;
        }

        .brand-actions-cell {
            width: 240px;
            text-align: right;
            white-space: nowrap;
        }

        .brand-auth-menu {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }

        .brand-auth-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            max-width: 100%;
            padding: 7px 12px;
            border-radius: 4px;
            border: 1px solid rgba(191, 219, 254, 0.45);
            background: rgba(255, 255, 255, 0.08);
            color: #f8fafc;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            line-height: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: middle;
        }

        .brand-auth-link:hover {
            background: rgba(255, 255, 255, 0.14);
            border-color: rgba(191, 219, 254, 0.7);
        }

        .brand-auth-link.has-menu::after {
            content: "▾";
            font-size: 11px;
            opacity: 0.9;
            flex: 0 0 auto;
        }

        .brand-auth-link[aria-expanded="true"] {
            background: rgba(255, 255, 255, 0.16);
            border-color: rgba(191, 219, 254, 0.8);
        }

        .brand-auth-link:focus {
            outline: 2px solid rgba(191, 219, 254, 0.9);
            outline-offset: 2px;
        }

        .brand-auth-dropdown {
            position: absolute;
            right: 0;
            top: calc(100% + 6px);
            min-width: 140px;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            background: #ffffff;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.18);
            text-align: left;
            z-index: 1000;
        }

        .brand-auth-dropdown[hidden] {
            display: none;
        }

        .brand-auth-dropdown-item {
            display: block;
            padding: 8px 10px;
            border-radius: 4px;
            color: #0f172a;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
        }

        .brand-auth-dropdown-item:hover {
            background: #eff6ff;
            color: #1d4ed8;
        }

        @media (max-width: 900px) {
            .brand-actions-cell {
                width: 150px;
            }

            .brand-auth-link {
                padding: 6px 10px;
                font-size: 12px;
            }

            nav a.nav-support-link {
                margin-left: 0;
                width: 34px;
                height: 34px;
                min-height: 34px;
                padding: 0;
            }

            nav a.nav-support-link .nav-support-text {
                display: none;
            }

            nav a.nav-support-link .nav-support-icon {
                display: block;
            }

            nav a.nav-support-link::after {
                content: attr(data-tooltip);
            }
        }

    </style>
</head>

<body>
    {% set request_path = request.path if request is defined and request.path is defined else '' %}
    {% set request_path_no_slash = request_path.rstrip('/') %}
    {% set nav_models_active = request_path_no_slash in ('', '/demo') or '/listfunc' in request_path or '/func_create' in request_path or '/func' in request_path or '/funclog' in request_path %}
    {% set nav_pods_active = '/listpod' in request_path or '/pod' in request_path %}
    {% set nav_snapshots_active = '/listsnapshot' in request_path or '/snapshot' in request_path %}
    {% set nav_nodes_active = '/listnode' in request_path or '/node' in request_path %}
    {% set nav_admin_active = '/admin' in request_path %}
    <table class="brand-header">
        <tr>
            <td class="brand-logo-cell"><img class="brand-logo" src="{{ url_for('static', filename='logo.svg') }}" alt="logo" width="48" height="48"></td>
            <td class="brand-title-cell">
                <h1>InferX — Serverless GPU Inference Platform for Production Workloads</h1>
            </td>
            <td class="brand-actions-cell">
                <div id="brand-auth-menu" class="brand-auth-menu">
                    <a href="#" id="login_logout" class="brand-auth-link">Action</a>
                    <div id="brand-auth-dropdown" class="brand-auth-dropdown" hidden>
                        <a id="brand-auth-logout" class="brand-auth-dropdown-item" href="#">Log out</a>
                    </div>
                </div>
            </td>
        </tr>
    </table>
    <nav>
        <a href="{{ hosturl }}listfunc" class="{% if nav_models_active %}active{% endif %}"> Models </a>
        <a href="{{ hosturl }}listpod" class="{% if nav_pods_active %}active{% endif %}"> Pods </a>
        <a href="{{ hosturl }}listsnapshot" class="{% if nav_snapshots_active %}active{% endif %}"> Snapshots </a>
        <a href="{{ hosturl }}listnode" id="nav-nodes-link" class="{% if nav_nodes_active %}active{% endif %}" style="display: none;"> Nodes </a>
        <a href="{{ hosturl }}admin" id="admin" class="{% if nav_admin_active %}active{% endif %}"> Admin </a>
        <a href="{{ slack_invite_url }}" class="nav-support-link" data-tooltip="Join Slack" aria-label="Support on Slack" target="_blank" rel="noopener noreferrer">
            <span class="nav-support-text">Support</span>
            <img class="nav-support-icon" src="https://a.slack-edge.com/80588/marketing/img/icons/icon_slack_hash_colored.png" alt="" aria-hidden="true" loading="lazy">
        </a>
    </nav>
    <script>
        const link = document.querySelector('#login_logout');
        const authMenu = document.querySelector('#brand-auth-menu');
        const authDropdown = document.querySelector('#brand-auth-dropdown');
        const logoutLink = document.querySelector('#brand-auth-logout');
        const username = {{ session.get('username', '') | tojson }};
        const userDisplayName = {{ session.get('display_name', session.get('username', '')) | tojson }};
        const activeTenantName = {{ session.get('active_tenant_name', session.get('tenant_name', '')) | tojson }};
        const tenantDisplayMap = {};
        const loginUrl = '{{ hosturl }}' + "login";
        const logoutUrl = '{{ hosturl }}' + "logout";
        const navNodesLink = document.querySelector('#nav-nodes-link');

        function isInferxAdminFromRoles(rolesData) {
            if (!Array.isArray(rolesData)) {
                return false;
            }

            return rolesData.some((rb) => {
                const rbObjType = String(rb && rb.objType || '').toLowerCase().trim();
                const rbRole = String(rb && rb.role || '').toLowerCase().trim();
                const rbTenant = String(rb && rb.tenant || '').toLowerCase().trim();
                return rbObjType === 'tenant' && rbTenant === 'system' && rbRole === 'admin';
            });
        }

        function setNodesNavVisibility(isVisible) {
            if (!navNodesLink) {
                return;
            }
            navNodesLink.style.display = isVisible ? '' : 'none';
        }

        function closeAuthDropdown() {
            if (!authDropdown || !link) {
                return;
            }
            authDropdown.hidden = true;
            link.setAttribute('aria-expanded', 'false');
        }

        function toggleAuthDropdown() {
            if (!authDropdown || !link) {
                return;
            }
            const nextOpen = authDropdown.hidden;
            authDropdown.hidden = !nextOpen;
            link.setAttribute('aria-expanded', nextOpen ? 'true' : 'false');
        }

        function tenantDisplayNameFromTenantObject(tenantObj) {
            if (!tenantObj) {
                return "";
            }

            const spec = tenantObj.object && tenantObj.object.spec ? tenantObj.object.spec : {};
            const displayName = (spec.display_name || spec.displayName || "").trim();
            if (displayName !== "") {
                return displayName;
            }

            return (tenantObj.name || "").trim();
        }

        function getTenantDisplayName(tenantName) {
            if (!tenantName) {
                return "";
            }

            const mapped = tenantDisplayMap[tenantName];
            if (typeof mapped === 'string' && mapped.trim() !== "") {
                return mapped;
            }

            return tenantName;
        }

        function applyTenantDisplayNames(root = document) {
            if (!root || !root.querySelectorAll) {
                return;
            }

            const elems = root.querySelectorAll('[data-tenant-name]');
            elems.forEach((elem) => {
                const tenantName = (elem.dataset.tenantName || '').trim();
                if (tenantName === "") {
                    return;
                }

                const displayName = getTenantDisplayName(tenantName);
                elem.textContent = displayName;
                elem.title = tenantName;
            });
        }

        function refreshTenantBadge() {
            return;
        }

        function updateTenantDisplayMap(entries) {
            if (!entries || typeof entries !== 'object') {
                return;
            }

            Object.entries(entries).forEach(([tenantName, displayName]) => {
                const tn = String(tenantName || '').trim();
                if (tn === '') {
                    return;
                }

                const dn = String(displayName || '').trim();
                tenantDisplayMap[tn] = dn === '' ? tn : dn;
            });

            applyTenantDisplayNames(document);
            refreshTenantBadge();
            document.dispatchEvent(new CustomEvent('tenant-display-map-updated'));
        }

        async function loadTenantDisplayMap() {
            if (username === '') {
                refreshTenantBadge();
                return;
            }

            try {
                const resp = await fetch('/demo/generate_tenants');
                if (!resp.ok) {
                    refreshTenantBadge();
                    return;
                }

                const tenants = await resp.json();
                const updates = {};
                tenants.forEach((tenantObj) => {
                    const tenantName = String(tenantObj.name || '').trim();
                    if (tenantName === '') {
                        return;
                    }

                    const displayName = tenantDisplayNameFromTenantObject(tenantObj);
                    updates[tenantName] = displayName === '' ? tenantName : displayName;
                });

                updateTenantDisplayMap(updates);
            } catch (_e) {
                refreshTenantBadge();
            }
        }

        async function configureNodesNavVisibility() {
            if (!navNodesLink) {
                return;
            }

            if (username === '') {
                setNodesNavVisibility(false);
                return;
            }

            if (String(username).trim().toLowerCase() === 'inferx_admin') {
                setNodesNavVisibility(true);
                return;
            }

            try {
                const resp = await fetch('/demo/generate_roles');
                if (!resp.ok) {
                    setNodesNavVisibility(false);
                    return;
                }

                const roles = await resp.json();
                setNodesNavVisibility(isInferxAdminFromRoles(roles));
            } catch (_e) {
                setNodesNavVisibility(false);
            }
        }

        window.getTenantDisplayName = getTenantDisplayName;
        window.applyTenantDisplayNames = applyTenantDisplayNames;
        window.updateTenantDisplayMap = updateTenantDisplayMap;
        window.tenantDisplayNameFromTenantObject = tenantDisplayNameFromTenantObject;

        if (username == "") {
            link.href = loginUrl;
            link.textContent = 'Log in';
            link.removeAttribute('aria-haspopup');
            link.removeAttribute('aria-expanded');
            link.classList.remove('has-menu');
            if (authDropdown) {
                authDropdown.hidden = true;
            }
        } else {
            link.href = '#';
            link.textContent = userDisplayName || username;
            link.setAttribute('aria-haspopup', 'menu');
            link.setAttribute('aria-expanded', 'false');
            link.classList.add('has-menu');
            if (logoutLink) {
                logoutLink.href = logoutUrl;
            }
            link.addEventListener('click', (event) => {
                event.preventDefault();
                toggleAuthDropdown();
            });
            document.addEventListener('click', (event) => {
                if (!authMenu || authMenu.contains(event.target)) {
                    return;
                }
                closeAuthDropdown();
            });
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeAuthDropdown();
                }
            });
        }

        refreshTenantBadge();
        applyTenantDisplayNames(document);
        loadTenantDisplayMap();
        configureNodesNavVisibility();

    </script>
    <hr class="nav-divider">
    <div class="content">
        {% block content %} {% endblock %}
    </div>
</body>

</html>
