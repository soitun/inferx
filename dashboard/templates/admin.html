{% extends 'base.html' %}

{% block content %}

<style>
    table,
    th,
    td {
        border: 1px solid black;
    }

    .tab {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        padding-bottom: 8px;
        margin-bottom: 8px;
        border-bottom: 1px solid #d7dee8;
    }

    .tab button {
        background: transparent;
        color: #475569;
        border: none;
        border-radius: 0;
        outline: none;
        padding: 8px 6px 10px 6px;
        cursor: pointer;
        font-size: clamp(17px, 1.35vw, 20px);
        font-weight: 600;
        line-height: 1.15;
        position: relative;
        transition: color 120ms ease, background-color 120ms ease;
    }

    .tab button::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        bottom: -8px;
        height: 2px;
        background: transparent;
        border-radius: 999px;
    }

    .tab button:hover {
        background: transparent;
        color: #1f2937;
    }

    .tab button.active {
        background: transparent;
        color: #be123c;
    }

    .tab button.active::after {
        background: #d64161;
    }

    .tab button:focus-visible {
        outline: 2px solid #f3b4c0;
        outline-offset: 2px;
    }

    .tabcontent {
        display: none;
        padding: 10px;
        border-top: none;
    }

    .tabcontent.active {
        display: block;
    }

    /* Non-billing admin tables reuse the shared .ix-table visuals from base.html.
       Keep .admin-data-table as an admin-specific sizing alias. */
    .content table.admin-data-table {
        width: 100%;
        font-size: 14px;
    }

    /* API key section polish */
    #Apikeys .apikey-actions {
        margin-top: 12px;
        display: flex;
        justify-content: flex-start;
    }

    #Apikeys .apikey-actions button,
    #Namespaces .namespace-actions button {
        padding: 8px 14px;
        border: 1px solid #c9d5e6;
        border-radius: 4px;
        background: #ffffff;
        color: #334155;
        font-weight: 600;
        cursor: pointer;
    }

    #Apikeys .apikey-actions button:enabled:hover,
    #Namespaces .namespace-actions button:enabled:hover {
        background: #f6faff;
        border-color: #afc2db;
    }

    #Apikeys .apikey-actions button:disabled,
    #Namespaces .namespace-actions button:disabled {
        background: #f3f4f6;
        color: #9ca3af;
        border-color: #d1d5db;
        cursor: not-allowed;
        pointer-events: none;
        opacity: 0.75;
    }

    /* Namespace tab polish */
    #Namespaces .namespace-actions {
        margin-top: 12px;
        display: flex;
        justify-content: flex-start;
    }

    #Namespaces .namespace-create-card {
        margin-top: 16px;
        padding: 14px 16px 16px 16px;
        border: 1px solid #cbd8ea;
        border-radius: 2px;
        background: linear-gradient(180deg, #f8fbff 0%, #f3f8ff 100%);
    }

    #Namespaces .namespace-create-card h2 {
        margin: 0;
        font-size: 18px;
        color: #1f2937;
    }

    #Namespaces .namespace-create-hint {
        margin: 6px 0 12px 0;
        font-size: 13px;
        color: #546274;
    }

    #Namespaces .namespace-create-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
        align-items: end;
    }

    #Namespaces .namespace-field label {
        display: block;
        margin-bottom: 4px;
        font-size: 13px;
        color: #334155;
        font-weight: 600;
    }

    #Namespaces .namespace-field input,
    #Namespaces .namespace-field select {
        width: 100%;
        padding: 7px 9px;
        border: 1px solid #b7c6dc;
        border-radius: 4px;
        background: #fff;
        color: #1f2937;
        font-size: 14px;
        box-sizing: border-box;
    }

    #Namespaces .namespace-field input:focus,
    #Namespaces .namespace-field select:focus {
        outline: none;
        border-color: #6b9ad6;
        box-shadow: 0 0 0 2px rgba(107, 154, 214, 0.18);
    }

    #Namespaces .namespace-field-readonly {
        width: 100%;
        min-height: 36px;
        padding: 7px 9px;
        border: 1px solid #b7c6dc;
        border-radius: 4px;
        background: #f8fafc;
        color: #1f2937;
        font-size: 14px;
        box-sizing: border-box;
        display: flex;
        align-items: center;
    }

    #Namespaces .namespace-create-submit {
        display: flex;
        justify-content: flex-end;
    }

    #Namespaces .namespace-create-submit button {
        min-width: 170px;
        padding: 9px 14px;
        border: 1px solid #2f6fb2;
        border-radius: 4px;
        background: #3b82f6;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
    }

    #Namespaces .namespace-create-submit button:hover {
        background: #2f74e8;
    }

    @media (max-width: 720px) {
        #Namespaces .namespace-create-grid {
            grid-template-columns: 1fr;
        }

        #Namespaces .namespace-create-submit button {
            width: 100%;
        }
    }

    #Apikeys .apikey-raw-value {
        display: inline-block;
        max-width: calc(100% - 34px);
        font-family: monospace;
        font-size: 12px;
        letter-spacing: 0.2px;
        color: #334155;
        overflow-wrap: anywhere;
        word-break: break-word;
        vertical-align: middle;
    }

    #Apikeys .apikey-copy-cell-btn {
        margin-left: 8px;
        width: 24px;
        height: 24px;
        padding: 0;
        border: 1px solid #c9d5e6;
        border-radius: 4px;
        background: #ffffff;
        color: #334155;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        position: relative;
        cursor: pointer;
    }

    #Apikeys .apikey-copy-cell-btn:hover {
        background: #f6faff;
        border-color: #afc2db;
    }

    #Apikeys .apikey-copy-cell-btn svg {
        width: 14px;
        height: 14px;
        stroke: currentColor;
        fill: none;
        stroke-width: 1.8;
        pointer-events: none;
    }

    #Apikeys .apikey-copy-cell-btn::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 50%;
        bottom: calc(100% + 6px);
        transform: translateX(-50%);
        background: #111827;
        color: #ffffff;
        font-size: 11px;
        line-height: 1.2;
        padding: 3px 6px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        z-index: 10;
    }

    #Apikeys .apikey-copy-cell-btn:hover::after,
    #Apikeys .apikey-copy-cell-btn:focus-visible::after {
        opacity: 1;
    }

    #Apikeys .apikey-copy-cell-btn.copied {
        border-color: #16a34a;
        color: #166534;
        background: #f0fdf4;
    }

    #Apikeys .apikey-create-card {
        margin-top: 16px;
        padding: 14px 16px 16px 16px;
        border: 1px solid #cbd8ea;
        border-radius: 2px;
        background: linear-gradient(180deg, #f8fbff 0%, #f3f8ff 100%);
    }

    #Apikeys .apikey-create-card h2 {
        margin: 0;
        font-size: 18px;
        color: #1f2937;
    }

    #Apikeys .apikey-create-hint {
        margin: 6px 0 12px 0;
        font-size: 13px;
        color: #546274;
    }

    #Apikeys .apikey-create-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 12px;
        align-items: end;
    }

    #Apikeys .apikey-field label {
        display: block;
        margin-bottom: 4px;
        font-size: 13px;
        color: #334155;
        font-weight: 600;
    }

    #Apikeys .label-with-help {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    #Apikeys .field-help {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        border: 1px solid #94a3b8;
        border-radius: 50%;
        background: #ffffff;
        color: #475569;
        font-size: 11px;
        line-height: 1;
        cursor: default;
        user-select: none;
    }

    #Apikeys .field-help:hover {
        color: #1f2937;
        border-color: #64748b;
    }

    #Apikeys .field-help:focus {
        outline: 1px solid #6b9ad6;
        outline-offset: 1px;
    }

    #Apikeys .apikey-field input,
    #Apikeys .apikey-field select {
        width: 100%;
        padding: 7px 9px;
        border: 1px solid #b7c6dc;
        border-radius: 4px;
        background: #fff;
        color: #1f2937;
        font-size: 14px;
        box-sizing: border-box;
    }

    #Apikeys .apikey-field input:focus,
    #Apikeys .apikey-field select:focus {
        outline: none;
        border-color: #6b9ad6;
        box-shadow: 0 0 0 2px rgba(107, 154, 214, 0.18);
    }

    #Apikeys .apikey-field-readonly {
        width: 100%;
        min-height: 36px;
        padding: 7px 9px;
        border: 1px solid #b7c6dc;
        border-radius: 4px;
        background: #f8fafc;
        color: #1f2937;
        font-size: 14px;
        box-sizing: border-box;
        display: flex;
        align-items: center;
    }

    #Apikeys .apikey-create-submit {
        display: flex;
        justify-content: flex-end;
    }

    #Apikeys .apikey-create-submit button {
        min-width: 150px;
        padding: 9px 14px;
        border: 1px solid #2f6fb2;
        border-radius: 4px;
        background: #3b82f6;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
    }

    #Apikeys .apikey-create-submit button:hover {
        background: #2f74e8;
    }

    @media (max-width: 720px) {
        #Apikeys .apikey-create-grid {
            grid-template-columns: 1fr;
        }

        #Apikeys .apikey-create-submit button {
            width: 100%;
        }
    }

    /* Billing tab styles */
    .summary-card {
        border: 1px solid #ccc;
        padding: 15px 25px;
        text-align: center;
        min-width: 140px;
        background: #fafafa;
    }

    .summary-card h4 {
        margin: 0 0 10px 0;
        color: #666;
        font-size: 12px;
        text-transform: uppercase;
    }

    .summary-card > div:first-of-type {
        font-size: 20px;
        font-weight: bold;
    }

    .summary-card .subtext {
        font-size: 12px;
        color: #888;
        margin-top: 5px;
    }

    .status-active {
        color: green;
    }

    .status-exceeded {
        color: red;
    }

    /* Stacked usage bar */
    .usage-bar-stack {
        display: flex;
        flex-direction: column-reverse;
        min-width: 8px;
        flex: 1;
        transition: height 0.3s ease;
    }

    .usage-bar-inference {
        background-color: #4CAF50;
    }

    .usage-bar-inference:hover {
        background-color: #45a049;
    }

    .usage-bar-standby {
        background-color: #2196F3;
    }

    .usage-bar-standby:hover {
        background-color: #1976D2;
    }

    /* Single bar for analytics */
    .usage-bar {
        background-color: #4CAF50;
        min-width: 8px;
        flex: 1;
        transition: height 0.3s ease;
    }

    .usage-bar:hover {
        background-color: #45a049;
    }

    #billing-pagination-controls,
    #billing-admin-credit-pagination-controls,
    #billing-admin-rate-pagination-controls {
        margin-top: 10px;
        text-align: center;
    }

    #billing-pagination-controls button,
    #billing-admin-credit-pagination-controls button,
    #billing-admin-rate-pagination-controls button {
        margin: 0 10px;
        padding: 5px 15px;
    }

    #billing-pagination-controls button:disabled,
    #billing-admin-credit-pagination-controls button:disabled,
    #billing-admin-rate-pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    #billing-admin-credits-form div,
    #billing-admin-rate-form div,
    #billing-admin-credit-history-section div,
    #billing-admin-rate-history-section div {
        margin: 10px 0;
    }

    #billing-admin-credits-form label,
    #billing-admin-rate-form label,
    #billing-admin-credit-history-section label,
    #billing-admin-rate-history-section label {
        display: inline-block;
        width: 190px;
    }

    #billing-admin-credits-form input,
    #billing-admin-rate-form input,
    #billing-admin-credits-form select,
    #billing-admin-rate-form select,
    #billing-admin-credit-history-section select,
    #billing-admin-rate-history-section select {
        width: 300px;
        padding: 5px;
    }

    #billing-admin-add-credits-btn:disabled,
    #billing-admin-add-rate-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .amount-positive { color: green; }
    .amount-negative { color: red; }
    .amount-zero { color: #888; }

    #usage-range-controls button.active-range {
        background-color: #4CAF50;
        color: #fff;
        border: 1px solid #4CAF50;
    }

    #usage-view-controls button.active-range {
        background-color: #4CAF50;
        color: #fff;
        border: 1px solid #4CAF50;
    }

    #usage-granularity-controls button.active-range {
        background-color: #4CAF50;
        color: #fff;
        border: 1px solid #4CAF50;
    }

    #analytics-hourly-view-controls button.active-range {
        background-color: #4CAF50;
        color: #fff;
        border: 1px solid #4CAF50;
    }

    #analytics-group-detail-granularity-controls button.active-range {
        background-color: #4CAF50;
        color: #fff;
        border: 1px solid #4CAF50;
    }

    /* Billing tables aligned with Usage Analytics style */
    .billing-analytics-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        border: 1px solid #aebfd1;
        background: #fff;
    }

    .billing-analytics-table th,
    .billing-analytics-table td {
        border: 1px solid #aebfd1;
        padding: 8px;
        vertical-align: middle;
    }

    .billing-analytics-table thead th {
        background: #f8fafc;
        color: #334155;
        font-weight: 600;
        white-space: nowrap;
    }

    .billing-analytics-table tbody tr:nth-child(odd) {
        background: #ffffff;
    }

    .billing-analytics-table tbody tr:nth-child(even) {
        background: #edf3fb;
    }

    .billing-analytics-table tbody tr:hover {
        background: #e2ecf9;
    }

    .billing-analytics-table tfoot td {
        font-weight: bold;
        background: #fafafa;
    }

    /* Credit history modern table style */
    #credit-history-container {
        margin-top: 4px;
    }

    #credit-history-table-wrap {
        overflow-x: auto;
        border: 1px solid #aebfd1;
        background: #ffffff;
    }

    #credit-history-table {
        width: 100%;
        min-width: 760px;
        border-collapse: collapse;
        font-size: 14px;
    }

    #credit-history-table th,
    #credit-history-table td {
        border: 1px solid #aebfd1;
        padding: 10px 12px;
        text-align: center;
    }

    #credit-history-table thead th {
        background: #f8fafc;
        color: #334155;
        font-weight: 600;
        white-space: nowrap;
    }

    #credit-history-table tbody tr:nth-child(odd) {
        background: #ffffff;
    }

    #credit-history-table tbody tr:nth-child(even) {
        background: #edf3fb;
    }

    #credit-history-table tbody tr:hover {
        background: #e2ecf9;
    }

    #credit-history-container #billing-pagination-controls {
        margin-top: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    #credit-history-container #billing-pagination-controls button {
        margin: 0;
        padding: 6px 14px;
        border: 1px solid #d1d9e6;
        border-radius: 4px;
        background: #ffffff;
        color: #334155;
    }

    #credit-history-container #billing-pagination-controls button:not(:disabled):hover {
        background: #f8fbff;
        border-color: #b7c6dc;
    }

    #credit-history-container #billing-page-info {
        color: #475569;
        font-weight: 600;
    }

    #Billing .billing-tenant-readonly {
        display: none;
        min-width: 220px;
        padding: 6px 10px;
        border: 1px solid #b7c6dc;
        border-radius: 4px;
        background: #f8fafc;
        color: #1f2937;
        font-size: 14px;
        line-height: 1.3;
        vertical-align: middle;
        box-sizing: border-box;
    }
</style>

<div class="tab">
    <button class="tablinks" onclick="openTab(event, 'Tenants')">Tenants</button>
    <button class="tablinks" onclick="openTab(event, 'Namespaces')">Namespaces</button>
    <button class="tablinks" onclick="openTab(event, 'Roles')">Roles</button>
    <button class="tablinks" onclick="openTab(event, 'Apikeys')">Apikeys</button>
    <button class="tablinks" onclick="openTab(event, 'Billing')">Billing</button>
    <button class="tablinks" id="billing-admin-tab-btn" onclick="openTab(event, 'BillingAdmin')" style="display: none;">Billing Admin</button>
</div>

<div id="Apikeys" class="tabcontent">
    <table class="ix-table admin-data-table" style="width:100%" id="items-table">
        <thead>
            <tr>
                <th style="width: 50px;">Select</th>
                <th>Name</th>
                <th>Username</th>
                <th>Raw Key (Hidden)</th>
                <th>Access Level</th>
                <th>Restricted Tenant</th>
                <th>Restricted Namespace</th>
                <th>Created (Local)</th>
                <th>Expires (Local)</th>
            </tr>
        </thead>

        <tbody>

        </tbody>
    </table>

    <div class="apikey-actions">
        <form id="delete-form" onsubmit="return false;">
            <button id="delete-button" type="button" onclick="delete_apikeys()" disabled>Delete Apikeys</button>
        </form>
    </div>

    <div class="apikey-create-card" id="apikey-create-card">
        <h2>Create API Key</h2>
        <div id="apikey-create-hint" class="apikey-create-hint">Select a tenant (required), then optionally narrow to a namespace and expiration.</div>
        <form id="add-form" class="apikey-create-grid" onsubmit="return false;">
        <div class="apikey-field">
            <label for="apikey_name">Key Name</label>
            <input type="text" id="apikey_name" placeholder="Enter key name" required>
        </div>
        <div class="apikey-field">
            <label for="apikey_access_level" class="label-with-help">
                <span>Access Level</span>
                <span class="field-help" tabindex="0" aria-label="Access level help" title="Permission level for this key. inference: inference endpoints only. read: read plus inference. full: read and write actions.">i</span>
            </label>
            <select id="apikey_access_level">
                <option value="inference">inference</option>
                <option value="read">read</option>
                <option value="full">full</option>
            </select>
        </div>
        <div class="apikey-field" id="apikey-tenant-select-field">
            <label for="apikey_restrict_tenant" class="label-with-help">
                <span>Tenant (Required)</span>
                <span class="field-help" tabindex="0" aria-label="Tenant help" title="Required. Every API key must belong to exactly one tenant.">i</span>
            </label>
            <select id="apikey_restrict_tenant" onchange="onApikeyRestrictTenantChange()">
                <option value="">Select tenant</option>
            </select>
        </div>
        <div class="apikey-field" id="apikey-tenant-readonly-field" style="display: none;">
            <label>Tenant (Required)</label>
            <div id="apikey-tenant-readonly-value" class="apikey-field-readonly"></div>
        </div>
        <div class="apikey-field" id="apikey-namespace-select-field">
            <label for="apikey_restrict_namespace" class="label-with-help">
                <span>Restrict to Namespace</span>
                <span class="field-help" tabindex="0" aria-label="Restrict namespace help" title="Optional. Limit this key to one namespace under the selected tenant.">i</span>
            </label>
            <select id="apikey_restrict_namespace" disabled>
                <option value="">(optional)</option>
            </select>
        </div>
        <div class="apikey-field" id="apikey-namespace-readonly-field" style="display: none;">
            <label>Restrict to Namespace</label>
            <div id="apikey-namespace-readonly-value" class="apikey-field-readonly"></div>
        </div>
        <div class="apikey-field">
            <label for="apikey_expires_days">Expires In (days)</label>
            <input type="number" id="apikey_expires_days" placeholder="(optional)" min="1">
        </div>
        <div class="apikey-create-submit">
            <button type="button" onclick="create_apikey()">Create Apikey</button>
        </div>
    </form>
    </div>

    <!-- Modal to display newly created API key -->
    <div id="apikey-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:4px; max-width:600px; width:90%; word-break:break-all;">
            <h3 style="margin-top:0;">API Key Created</h3>
            <p style="margin: 0 0 10px 0; font-size: 14px; color: #475569;">The API key has been created successfully. Copy it for use in API requests (for example, in the Authorization header as a Bearer token).</p>
            <div id="apikey-modal-value" style="background:#f0f0f0; padding:10px; font-family:monospace; font-size:14px; border-radius:2px; margin:10px 0;"></div>
            <div style="margin-top:5px; font-size:13px; color:#555;">
                <span>Access Level: <strong id="apikey-modal-access-level"></strong></span>
                <span id="apikey-modal-expires-wrap" style="display:none;"> | Expires (Local): <strong id="apikey-modal-expires"></strong></span>
            </div>
            <div style="margin-top:15px; text-align:right;">
                <button onclick="copyApikeyToClipboard()" style="margin-right:10px;">Copy Key</button>
                <button onclick="closeApikeyModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="Roles" class="tabcontent">
    <h3>Tenant Roles</h3>
    <table class="ix-table admin-data-table" style="width:100%" id="tenant-roles-table">
        <thead>
            <tr>
                <th rowspan="2">Tenant</th>

                <th colspan="2" style="text-align: center; border-bottom: 1px solid #aebfd1;">Role</th>
            </tr>
            <tr>
                <th style="width: 100px; text-align: center;">IsAdmin</th>
                <th style="width: 100px; text-align: center;">IsUser</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <br>

    <h3>Namespace Roles</h3>
    <table class="ix-table admin-data-table" style="width:100%" id="namespace-roles-table">
        <thead>
            <tr>
                <th rowspan="2">Tenant</th>
                <th rowspan="2">Namespace</th>

                <th colspan="2" style="text-align: center; border-bottom: 1px solid #aebfd1;">Role</th>
            </tr>
            <tr>
                <th style="width: 100px; text-align: center;">IsAdmin</th>
                <th style="width: 100px; text-align: center;">IsUser</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="Namespaces" class="tabcontent">
    <table class="ix-table admin-data-table" style="width:100%" id="namespaces-table">
        <thead>
            <tr>
                <th rowspan="2" style="width: 150px;">Select</th>
                <th rowspan="2">Tenant</th>
                <th rowspan="2">Namespace</th>

                <th colspan="2" style="text-align: center; border-bottom: 1px solid #aebfd1;">Role</th>
                <th rowspan="2" style="text-align: center;">Admins</th>
                <th rowspan="2" style="text-align: center;">Users</th>
            </tr>
            <tr>
                <th style="width: 100px; text-align: center;">IsAdmin</th>
                <th style="width: 100px; text-align: center;">IsUser</th>
            </tr>
        </thead>

        <tbody>

        </tbody>
    </table>

    <div class="namespace-actions">
        <form id="delete-namespace-form" onsubmit="return false;">
            <button id="delete-namespace-button" type="button" onclick="delete_namespaces()">Delete Namespaces</button>
        </form>
    </div>

    <div class="namespace-create-card" id="namespace-create-card">
        <h2>Add Namespace</h2>
        <div class="namespace-create-hint">Choose a tenant and create a new namespace under it.</div>
        <form id="add-namespace-form" class="namespace-create-grid" onsubmit="return false;">
            <div class="namespace-field" id="namespace-tenant-select-field">
                <label for="tenant_dropdown">Tenant</label>
                <select id="tenant_dropdown" required>
                    <option disabled selected>Select a tenant</option>
                </select>
            </div>
            <div class="namespace-field" id="namespace-tenant-readonly-field" style="display: none;">
                <label>Tenant</label>
                <div id="namespace-tenant-readonly-value" class="namespace-field-readonly"></div>
            </div>
            <div class="namespace-field">
                <label for="namespace_name">Namespace Name</label>
                <input type="text" id="namespace_name" placeholder="Enter namespace name" required>
            </div>
            <div class="namespace-create-submit">
                <button type="button" onclick="create_namespace()">Create Namespace</button>
            </div>
        </form>
    </div>
</div>

<div id="Tenants" class="tabcontent">
    <table class="ix-table admin-data-table" style="width:100%" id="tenants-table">
        <thead>
            <tr>
                <th rowspan="2">Tenant</th>
                <th colspan="2" style="text-align: center; border-bottom: 1px solid #aebfd1;">Role</th>
                <th rowspan="2" style="text-align: center;">Admins</th>
                <th rowspan="2" style="text-align: center;">Users</th>
            </tr>
            <tr>
                <th style="width: 100px; text-align: center;">IsAdmin</th>
                <th style="width: 100px; text-align: center;">IsUser</th>
            </tr>
        </thead>

        <tbody>

        </tbody>
    </table>

</div>

<div id="Billing" class="tabcontent">
    <!-- Tenant Selector -->
    <div style="margin-bottom: 20px;">
        <label for="billing_tenant_select" style="font-size: 16px; font-weight: bold;">Tenant: </label>
        <select id="billing_tenant_select" onchange="loadBillingData()" style="padding: 5px; font-size: 14px;">
            <option value="" disabled selected>Select a tenant</option>
        </select>
        <span id="billing-tenant-readonly" class="billing-tenant-readonly"></span>
    </div>

    <!-- No tenant selected message -->
    <div id="billing-no-tenant" style="color: #888; padding: 40px; text-align: center; font-size: 16px;">
        Select a tenant to view billing information
    </div>

    <!-- Billing content (hidden until tenant selected) -->
    <div id="billing-content" style="display: none;">
        <!-- Credit Summary Cards -->
        <div id="billing-summary" style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
            <div class="summary-card">
                <h4>Current Balance</h4>
                <div id="balance-value">--</div>
                <div id="balance-subtext" class="subtext">--</div>
            </div>
            <div class="summary-card">
                <h4>Total Used</h4>
                <div id="used-value">--</div>
                <div id="used-breakdown" class="subtext">
                    <span id="used-inference">--</span> |
                    <span id="used-standby">--</span>
                </div>
            </div>
            <div class="summary-card">
                <h4>Quota Limit</h4>
                <div id="threshold-value">--</div>
                <div class="subtext">threshold</div>
            </div>
            <div class="summary-card">
                <h4>Status</h4>
                <div id="status-value">--</div>
            </div>
        </div>

        <!-- Usage Chart -->
        <div id="usage-chart-container" style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
                <h3 style="margin: 0;">Usage</h3>
                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <div id="usage-range-controls" style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <button type="button" onclick="setUsageRangeHours(24)" id="usage-range-24h">Last 24h</button>
                        <button type="button" onclick="setUsageRangeHours(24 * 7)" id="usage-range-7d">Last 7d</button>
                        <button type="button" onclick="setUsageRangeHours(24 * 30)" id="usage-range-30d">Last 30d</button>
                        <button type="button" onclick="showBillingCustomRange()" id="usage-range-custom">Custom</button>
                    </div>
                    <div id="usage-view-controls" style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 12px; color: #666;">View:</span>
                        <button type="button" onclick="setUsageViewMode('chart')" id="usage-view-chart">Chart</button>
                        <button type="button" onclick="setUsageViewMode('table')" id="usage-view-table">Table</button>
                    </div>
                    <div id="usage-granularity-controls" style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 12px; color: #666;">Granularity:</span>
                        <button type="button" onclick="setUsageGranularity('hourly')" id="usage-granularity-hourly">Hourly</button>
                        <button type="button" onclick="setUsageGranularity('daily')" id="usage-granularity-daily">Daily</button>
                        <button type="button" onclick="setUsageGranularity('weekly')" id="usage-granularity-weekly">Weekly</button>
                    </div>
                </div>
            </div>
            <div id="billing-custom-range" style="display: none; align-items: center; gap: 8px; flex-wrap: wrap; margin: 10px 0 6px;">
                <strong style="font-size: 12px; color: #666;">Custom Range (Local)</strong>
                <input type="datetime-local" id="billing-usage-start" style="font-size: 12px;">
                <span style="font-size: 12px;">to</span>
                <input type="datetime-local" id="billing-usage-end" style="font-size: 12px;">
                <button type="button" onclick="applyBillingCustomRange()">Apply</button>
            </div>
            <div id="usage-chart-view">
                <div id="usage-chart" style="display: flex; align-items: flex-end; height: 100px; gap: 2px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">
                    <!-- Bars generated by JS -->
                </div>
                <div id="usage-chart-labels" style="display: flex; gap: 2px; font-size: 10px; color: #666;">
                    <!-- Labels generated by JS -->
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-top: 4px;">
                    <div>
                        <span style="display: inline-block; width: 10px; height: 10px; background: #4CAF50;"></span> Inference
                        <span style="display: inline-block; width: 10px; height: 10px; background: #2196F3; margin-left: 10px;"></span> Standby
                    </div>
                    <div>(Local)</div>
                </div>
            </div>
            <div id="usage-table-container" style="display: none; margin-top: 12px;">
                <h4 style="margin: 0 0 8px 0;">
                    Usage Table View (<span id="usage-table-granularity">Hourly</span>, Local)
                </h4>
                <div style="overflow-x: auto;">
                        <table id="usage-table" class="billing-analytics-table">
                            <thead>
                                <tr>
                                <th style="text-align: left; cursor: pointer;" onclick="sortUsageTable('period')">
                                    Period <span id="usage-sort-period-icon">▼</span>
                                </th>
                                <th style="text-align: right; cursor: pointer;" onclick="sortUsageTable('inf_hours')">
                                    Inference (hrs) <span id="usage-sort-inf-hours-icon"></span>
                                </th>
                                <th style="text-align: right; cursor: pointer;" onclick="sortUsageTable('sby_hours')">
                                    Standby (hrs) <span id="usage-sort-sby-hours-icon"></span>
                                </th>
                                <th style="text-align: right; cursor: pointer;" onclick="sortUsageTable('inf_cost')">
                                    Inference (USD) <span id="usage-sort-inf-cost-icon"></span>
                                </th>
                                <th style="text-align: right; cursor: pointer;" onclick="sortUsageTable('sby_cost')">
                                    Standby (USD) <span id="usage-sort-sby-cost-icon"></span>
                                </th>
                                <th style="text-align: right; cursor: pointer;" onclick="sortUsageTable('total_cost')">
                                    Total (USD) <span id="usage-sort-total-cost-icon"></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr>
                                <td style="text-align: left;">Total</td>
                                <td id="usage-table-total-inf-hours" style="text-align: right;">--</td>
                                <td id="usage-table-total-sby-hours" style="text-align: right;">--</td>
                                <td id="usage-table-total-inf-cost" style="text-align: right;">--</td>
                                <td id="usage-table-total-sby-cost" style="text-align: right;">--</td>
                                <td id="usage-table-total-cost" style="text-align: right;">--</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Usage Analytics Section -->
        <div id="usage-analytics-container" style="margin-bottom: 20px; border: 1px solid #ccc; padding: 15px;">
            <h3 style="cursor: pointer; margin: 0;" onclick="toggleUsageAnalytics()">
                Usage Analytics <span id="analytics-toggle-icon" style="font-size: 14px;">▶</span>
            </h3>

            <div id="usage-analytics-content" style="display: none; margin-top: 15px;">
                <div id="analytics-custom-range" style="display: none; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;">
                    <strong style="font-size: 12px; color: #666;">Custom Range (Local)</strong>
                    <input type="datetime-local" id="usage-start" style="font-size: 12px;">
                    <span style="font-size: 12px;">to</span>
                    <input type="datetime-local" id="usage-end" style="font-size: 12px;">
                    <button type="button" onclick="applyCustomUsageRange()">Apply</button>
                </div>
                <!-- Summary cards hidden by request -->

                <!-- Time Range Selector -->
                <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                    <label>Time Range:</label>
                    <select id="analytics-time-range" onchange="onAnalyticsTimeRangeChange()">
                        <option value="24">Last 24 Hours</option>
                        <option value="168">Last 7 Days</option>
                        <option value="720">Last 30 Days</option>
                        <option value="custom">Custom Range</option>
                    </select>
                    <div id="analytics-range-controls" style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <button type="button" onclick="setAnalyticsRangeHours(24)" id="analytics-range-24h">24h</button>
                        <button type="button" onclick="setAnalyticsRangeHours(24 * 7)" id="analytics-range-7d">7d</button>
                        <button type="button" onclick="setAnalyticsRangeHours(24 * 30)" id="analytics-range-30d">30d</button>
                    </div>

                    <span id="analytics-loading" style="display: none; margin-left: 10px; color: #888;">
                        Loading...
                    </span>
                </div>

                <!-- View Mode Selector -->
                <div style="margin-bottom: 15px;">
                    <label>View By:</label>
                    <input type="radio" name="analytics-view" value="tenant" checked onchange="loadAnalyticsView()"> Tenant
                    <input type="radio" name="analytics-view" value="model" onchange="loadAnalyticsView()"> Model
                    <input type="radio" name="analytics-view" value="namespace" onchange="loadAnalyticsView()"> Namespace
                </div>

                <div id="analytics-hourly-view-controls" style="display: flex; align-items: center; gap: 6px; margin-bottom: 12px;">
                    <span style="font-size: 12px; color: #666;">Hourly View:</span>
                    <button type="button" onclick="setAnalyticsHourlyViewMode('chart')" id="analytics-hourly-view-chart">Chart</button>
                    <button type="button" onclick="setAnalyticsHourlyViewMode('table')" id="analytics-hourly-view-table">Table</button>
                </div>

                <!-- Results Area -->
                <div id="analytics-chart-area" style="display: none;">
                    <!-- Chart rendered here -->
                </div>

                <div id="analytics-hourly-table-area" style="display: none;">
                    <h4 style="margin: 0 0 8px 0;">
                        Hourly Table View (<span id="analytics-hourly-table-granularity">Hourly</span>, Local)
                    </h4>
                    <table id="analytics-hourly-table" class="billing-analytics-table">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 8px;">Period</th>
                                <th style="text-align: right; padding: 8px;">GPU-Hours</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr>
                                <td style="padding: 8px;">Total</td>
                                <td id="analytics-hourly-table-total" style="text-align: right; padding: 8px;">--</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div id="analytics-table-area" style="display: none;">
                    <div style="overflow-x: auto;">
                        <table id="analytics-table" class="billing-analytics-table" style="min-width: 920px;">
                            <thead>
                                <tr>
                                    <th id="analytics-group-header" style="text-align: left; padding: 8px; cursor: pointer;" onclick="sortAnalyticsTable('name')">
                                        Group <span id="sort-name-icon"></span>
                                    </th>
                                    <th style="text-align: right; padding: 8px; cursor: pointer;" onclick="sortAnalyticsTable('inf_hours')">
                                        Inference (hrs) <span id="sort-inf-hours-icon"></span>
                                    </th>
                                    <th style="text-align: right; padding: 8px; cursor: pointer;" onclick="sortAnalyticsTable('sby_hours')">
                                        Standby (hrs) <span id="sort-sby-hours-icon"></span>
                                    </th>
                                    <th style="text-align: right; padding: 8px; cursor: pointer;" onclick="sortAnalyticsTable('inf_cost')">
                                        Inference (USD) <span id="sort-inf-cost-icon"></span>
                                    </th>
                                    <th style="text-align: right; padding: 8px; cursor: pointer;" onclick="sortAnalyticsTable('sby_cost')">
                                        Standby (USD) <span id="sort-sby-cost-icon"></span>
                                    </th>
                                    <th style="text-align: right; padding: 8px; cursor: pointer;" onclick="sortAnalyticsTable('total_cost')">
                                        Total (USD) <span id="sort-total-cost-icon">▼</span>
                                    </th>
                                    <th style="text-align: right; padding: 8px; width: 200px; cursor: pointer;" onclick="sortAnalyticsTable('percent')">
                                        % of Total <span id="sort-percent-icon"></span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr>
                                    <td style="padding: 8px;">Total</td>
                                    <td id="analytics-table-total-inf-hours" style="text-align: right; padding: 8px;">--</td>
                                    <td id="analytics-table-total-sby-hours" style="text-align: right; padding: 8px;">--</td>
                                    <td id="analytics-table-total-inf-cost" style="text-align: right; padding: 8px;">--</td>
                                    <td id="analytics-table-total-sby-cost" style="text-align: right; padding: 8px;">--</td>
                                    <td id="analytics-table-total-cost" style="text-align: right; padding: 8px;">--</td>
                                    <td style="text-align: right; padding: 8px;">100%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div id="analytics-group-detail-area" style="display: none; margin-top: 12px; border: 1px solid #aebfd1; padding: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                        <h4 id="analytics-group-detail-title" style="margin: 0;">Breakdown</h4>
                        <div id="analytics-group-detail-granularity-controls" style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 12px; color: #666;">Granularity:</span>
                            <button type="button" onclick="setAnalyticsDetailGranularity('hourly')" id="analytics-detail-granularity-hourly">Hourly</button>
                            <button type="button" onclick="setAnalyticsDetailGranularity('daily')" id="analytics-detail-granularity-daily">Daily</button>
                            <button type="button" onclick="setAnalyticsDetailGranularity('weekly')" id="analytics-detail-granularity-weekly">Weekly</button>
                        </div>
                        <span id="analytics-group-detail-loading" style="display: none; font-size: 12px; color: #888;">Loading...</span>
                    </div>
                    <div id="analytics-group-detail-message" style="display: none; color: #888; margin-bottom: 8px;"></div>
                    <div style="overflow-x: auto;">
                        <table id="analytics-group-detail-table" class="billing-analytics-table">
                            <thead>
                                <tr>
                                    <th style="text-align: left; padding: 8px; cursor: pointer;" onclick="sortAnalyticsGroupDetailTable('period')">
                                        Period (<span id="analytics-group-detail-period-granularity">Hourly</span>, Local) <span id="detail-sort-period-icon">▼</span>
                                    </th>
                                    <th style="text-align: right; padding: 8px; cursor: pointer;" onclick="sortAnalyticsGroupDetailTable('inf_hours')">
                                        Inference (hrs) <span id="detail-sort-inf-hours-icon"></span>
                                    </th>
                                    <th style="text-align: right; padding: 8px; cursor: pointer;" onclick="sortAnalyticsGroupDetailTable('sby_hours')">
                                        Standby (hrs) <span id="detail-sort-sby-hours-icon"></span>
                                    </th>
                                    <th style="text-align: right; padding: 8px; cursor: pointer;" onclick="sortAnalyticsGroupDetailTable('inf_cost')">
                                        Inference (USD) <span id="detail-sort-inf-cost-icon"></span>
                                    </th>
                                    <th style="text-align: right; padding: 8px; cursor: pointer;" onclick="sortAnalyticsGroupDetailTable('sby_cost')">
                                        Standby (USD) <span id="detail-sort-sby-cost-icon"></span>
                                    </th>
                                    <th style="text-align: right; padding: 8px; cursor: pointer;" onclick="sortAnalyticsGroupDetailTable('total_cost')">
                                        Total (USD) <span id="detail-sort-total-cost-icon"></span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr>
                                    <td style="padding: 8px;">Total</td>
                                    <td id="analytics-group-total-inf-hours" style="text-align: right; padding: 8px;">--</td>
                                    <td id="analytics-group-total-sby-hours" style="text-align: right; padding: 8px;">--</td>
                                    <td id="analytics-group-total-inf-cost" style="text-align: right; padding: 8px;">--</td>
                                    <td id="analytics-group-total-sby-cost" style="text-align: right; padding: 8px;">--</td>
                                    <td id="analytics-group-total-cost" style="text-align: right; padding: 8px;">--</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="analytics-empty" style="display: none; text-align: center; padding: 40px; color: #888;">
                    <p>No usage data for the selected period.</p>
                </div>

                <!-- Error State -->
                <div id="analytics-error" style="display: none; text-align: center; padding: 20px; color: #dc3545; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px;">
                    <p><strong>Failed to load analytics</strong></p>
                    <p id="analytics-error-message" style="font-size: 12px;"></p>
                    <button onclick="loadAnalytics()">Retry</button>
                </div>
            </div>
        </div>

        <!-- Credit History -->
        <div id="credit-history-container">
            <h3>Credit History</h3>
            <div id="credit-history-table-wrap">
                <table id="credit-history-table">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="sortCreditHistoryTable('date')">
                                Date/Time (Local) <span id="credit-sort-date-icon">▼</span>
                            </th>
                            <th style="cursor: pointer;" onclick="sortCreditHistoryTable('amount')">
                                Amount (USD) <span id="credit-sort-amount-icon"></span>
                            </th>
                            <th style="cursor: pointer;" onclick="sortCreditHistoryTable('note')">
                                Note <span id="credit-sort-note-icon"></span>
                            </th>
                            <th style="cursor: pointer;" onclick="sortCreditHistoryTable('payment_ref')">
                                Payment Ref <span id="credit-sort-payment-ref-icon"></span>
                            </th>
                            <th style="cursor: pointer;" onclick="sortCreditHistoryTable('added_by')">
                                Added By <span id="credit-sort-added-by-icon"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="billing-pagination-controls">
                <button id="prev-page-btn" onclick="billingPrevPage()" disabled>&laquo; Prev</button>
                <span id="billing-page-info">Page 1 of 1</span>
                <button id="next-page-btn" onclick="billingNextPage()" disabled>Next &raquo;</button>
            </div>
        </div>
    </div>
</div>

<div id="BillingAdmin" class="tabcontent">
    <div id="billing-admin-no-access" style="display: none; color: #888; padding: 40px; text-align: center; font-size: 16px;">
        Billing Admin is only available to Inferx administrators.
    </div>

    <div id="billing-admin-content" style="display: none;">
        <div id="billing-admin-message" style="display: none; margin-bottom: 15px; padding: 10px; border-radius: 4px; position: sticky; top: 10px; z-index: 10;"></div>
        <div style="display: grid; gap: 20px;">
            <div id="billing-admin-credits-form" style="border: 1px solid #ccc; padding: 15px; background: #f9f9f9;">
                <h3 style="margin-top: 0;">Add Credits</h3>
                <p style="font-size: 12px; color: #666;">Admin-only action. Amount is in USD.</p>
                <div>
                    <label>Tenant:</label>
                    <select id="billing-admin-credit-tenant">
                        <option value="" disabled selected>Select a tenant</option>
                    </select>
                </div>
                <div>
                    <label>Amount (USD):</label>
                    <input type="number" id="billing-admin-credit-amount" step="0.01" placeholder="e.g., 50.00 or -50.00">
                </div>
                <div>
                    <label>Note:</label>
                    <input type="text" id="billing-admin-credit-note" placeholder="Optional note">
                </div>
                <div>
                    <label>Payment Ref:</label>
                    <input type="text" id="billing-admin-credit-payment-ref" placeholder="Invoice number">
                </div>
                <button id="billing-admin-add-credits-btn" onclick="addCredits()" style="margin-top: 10px; padding: 8px 20px;">Add Credits</button>
            </div>

            <div id="billing-admin-credit-history-section" style="border: 1px solid #ccc; padding: 15px; background: #f9f9f9;">
                <h3 style="cursor: pointer; margin-top: 0;" onclick="toggleBillingAdminCreditHistory()">
                    Credit History <span id="billing-admin-credit-toggle-icon">▶</span>
                </h3>
                <div id="billing-admin-credit-history-content" style="display: none;">
                    <div>
                        <label>Tenant:</label>
                        <select id="billing-admin-credit-history-tenant" onchange="loadBillingAdminCreditHistory(0)">
                            <option value="all" selected>All Tenants</option>
                        </select>
                    </div>
                    <table class="ix-table admin-data-table" style="width:100%" id="billing-admin-credit-history-table">
                        <thead>
                            <tr>
                                <th>Tenant</th>
                                <th>Date/Time (Local)</th>
                                <th>Amount (USD)</th>
                                <th>Note</th>
                                <th>Payment Ref</th>
                                <th>Added By</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6" style="text-align: center; color: #888;">No credit history</td></tr>
                        </tbody>
                    </table>
                    <div id="billing-admin-credit-pagination-controls">
                        <button id="billing-admin-credit-prev-page-btn" onclick="billingAdminCreditPrevPage()" disabled>&laquo; Prev</button>
                        <span id="billing-admin-credit-page-info">Page 1 of 1</span>
                        <button id="billing-admin-credit-next-page-btn" onclick="billingAdminCreditNextPage()" disabled>Next &raquo;</button>
                    </div>
                </div>
            </div>

            <div id="billing-admin-rate-form" style="border: 1px solid #ccc; padding: 15px; background: #f9f9f9;">
                <h3 style="margin-top: 0;">Add Billing Rate</h3>
                <p style="font-size: 12px; color: #666;">Admin-only action. Rate unit is cents per hour.</p>
                <div>
                    <label>Usage Type:</label>
                    <select id="billing-rate-usage-type">
                        <option value="inference" selected>Inference</option>
                        <option value="standby">Standby</option>
                    </select>
                </div>
                <div>
                    <label>Rate (cents/hour):</label>
                    <input type="number" id="billing-rate-cents" min="0" step="1" placeholder="e.g., 800">
                </div>
                <div>
                    <label>Scope:</label>
                    <select id="billing-rate-scope" onchange="onBillingRateScopeChange()">
                        <option value="global" selected>Global</option>
                        <option value="tenant">Tenant Override</option>
                    </select>
                </div>
                <div id="billing-rate-tenant-row" style="display: none;">
                    <label>Rate Tenant:</label>
                    <select id="billing-rate-tenant">
                        <option value="" disabled selected>Select a tenant</option>
                    </select>
                </div>
                <div>
                    <label>Effective From (Local):</label>
                    <input type="datetime-local" id="billing-rate-effective-from">
                </div>
                <div>
                    <label>Effective To (Local, Optional):</label>
                    <input type="datetime-local" id="billing-rate-effective-to">
                </div>
                <button id="billing-admin-add-rate-btn" onclick="addBillingRate()" style="margin-top: 10px; padding: 8px 20px;">Add Rate</button>
            </div>

            <div id="billing-admin-rate-history-section" style="border: 1px solid #ccc; padding: 15px; background: #f9f9f9;">
                <h3 style="cursor: pointer; margin-top: 0;" onclick="toggleBillingAdminRateHistory()">
                    Rate Add History <span id="billing-admin-rate-toggle-icon">▶</span>
                </h3>
                <div id="billing-admin-rate-history-content" style="display: none;">
                    <table class="ix-table admin-data-table" style="width:100%" id="billing-admin-rate-history-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Scope</th>
                                <th>Usage Type</th>
                                <th>Rate</th>
                                <th>Effective From (Local)</th>
                                <th>Effective To (Local)</th>
                                <th>Created At (Local)</th>
                                <th>Added By</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="8" style="text-align: center; color: #888;">No rate history</td></tr>
                        </tbody>
                    </table>
                    <div id="billing-admin-rate-pagination-controls">
                        <button id="billing-admin-rate-prev-page-btn" onclick="billingAdminRatePrevPage()" disabled>&laquo; Prev</button>
                        <span id="billing-admin-rate-page-info">Page 1 of 1</span>
                        <button id="billing-admin-rate-next-page-btn" onclick="billingAdminRateNextPage()" disabled>Next &raquo;</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    async function fetchWithAuth(url, options) {
        const resp = await fetch(url, options);
        if (resp.status === 401 || resp.status === 403 || resp.redirected) {
            window.location.href = '/demo/login';
            throw new Error('Session expired');
        }
        return resp;
    }

    function tenantDisplayLabel(tenantName) {
        if (window.getTenantDisplayName) {
            return window.getTenantDisplayName(tenantName);
        }
        return tenantName;
    }

    function tenantDisplayNameFromObj(tenantObj) {
        if (window.tenantDisplayNameFromTenantObject) {
            return window.tenantDisplayNameFromTenantObject(tenantObj);
        }
        return tenantObj?.name || '';
    }

    function tenantLinkLabelHtml(tenantName) {
        return `<span data-tenant-name="${tenantName}">${tenantName}</span>`;
    }

    function upsertTenantDisplayMapFromList(tenants) {
        if (!Array.isArray(tenants) || !window.updateTenantDisplayMap) {
            return;
        }

        const map = {};
        tenants.forEach((tenantObj) => {
            const tenantName = String(tenantObj?.name || '').trim();
            if (tenantName === '') {
                return;
            }
            map[tenantName] = tenantDisplayNameFromObj(tenantObj);
        });
        window.updateTenantDisplayMap(map);
    }

    function openTab(evt, tabName) {
        const tabcontent = document.getElementsByClassName("tabcontent");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
        }

        const tablinks = document.getElementsByClassName("tablinks");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }

        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");

        localStorage.setItem('currentTab', tabName);
    }

    window.onload = async function () {
        const savedTab = localStorage.getItem('currentTab') || 'Apikeys';
        let targetBtn = document.querySelector(`button[onclick*="'${savedTab}'"]`);
        let targetTab = savedTab;
        if (!targetBtn) {
            targetBtn = document.querySelector(`button[onclick*="'Apikeys'"]`);
            targetTab = 'Apikeys';
        }
        if (targetBtn) {
            openTab({ currentTarget: targetBtn }, targetTab);
        }
        await initBillingAdminAccess();
    };

    // =====================================================
    // Billing Tab Functions
    // =====================================================

    // Billing state
    let billingCurrentPage = 0;
    let billingTotalPages = 1;
    const billingPageSize = 20;
    const billingAdminCreditHistoryPageSize = 20;
    const billingAdminRateHistoryPageSize = 20;
    let billingAdminCreditHistoryPage = 0;
    let billingAdminCreditHistoryTotalPages = 1;
    let billingAdminRateHistoryPage = 0;
    let billingAdminRateHistoryTotalPages = 1;
    let billingAdminCreditHistoryExpanded = false;
    let billingAdminRateHistoryExpanded = false;
    let billingAdminMessageTimer = null;
    let billingIsSubmitting = false;
    let billingTenantsPopulated = false;
    let billingAdminTenantsPopulated = false;
    let billingAdminAccessReady = false;
    let billingAdminAccessPromise = null;
    let billingAdminIsInferxAdmin = false;
    let billingUsageRange = { mode: 'hours', hours: 24 };
    let billingUsageViewMode = 'chart';
    let billingUsageGranularity = 'hourly';
    let billingUsageTableReady = false;
    let billingUsageRawRows = [];
    let billingUsageTableRows = [];
    let billingUsageTableGranularity = 'hourly';
    let billingUsageSortColumn = 'period';
    let billingUsageSortDirection = 'desc';
    let billingCreditHistoryRows = [];
    let billingCreditSortColumn = 'date';
    let billingCreditSortDirection = 'desc';
    let analyticsUsageRange = { mode: 'hours', hours: 24 };
    let apikeyRestrictNamespacesByTenant = {};
    let apikeyCreatorIsInferxAdmin = false;

    // Called when Billing tab is opened
    async function populateBillingTenants() {
        if (billingTenantsPopulated) return;

        const dropdown = document.getElementById('billing_tenant_select');
        const readonlyEl = document.getElementById('billing-tenant-readonly');

        try {
            const [roles, tenants] = await Promise.all([
                fetchWithAuth('/demo/generate_roles').then(r => r.json()),
                fetchWithAuth('/demo/generate_tenants').then(r => r.json())
            ]);

            upsertTenantDisplayMapFromList(tenants);
            const allowedTenants = [];
            tenants.forEach(t => {
                if (IsAdmin(roles, t.name, "") || IsUser(roles, t.name, "")) {
                    const label = tenantDisplayNameFromObj(t);
                    const option = document.createElement('option');
                    option.value = t.name;
                    option.textContent = label;
                    dropdown.appendChild(option);
                    allowedTenants.push({ value: t.name, label });
                }
            });

            if (allowedTenants.length === 1) {
                dropdown.value = allowedTenants[0].value;
                dropdown.style.display = 'none';
                if (readonlyEl) {
                    readonlyEl.textContent = allowedTenants[0].label;
                    readonlyEl.style.display = 'inline-block';
                }
                await loadBillingData();
            } else {
                dropdown.style.display = '';
                if (readonlyEl) {
                    readonlyEl.textContent = '';
                    readonlyEl.style.display = 'none';
                }
            }

            billingTenantsPopulated = true;
        } catch (error) {
            console.error('Failed to populate billing tenants:', error);
        }
    }

    function showBillingAdminMessage(message, isError) {
        const el = document.getElementById('billing-admin-message');
        if (!el) return;

        if (billingAdminMessageTimer) {
            clearTimeout(billingAdminMessageTimer);
            billingAdminMessageTimer = null;
        }

        el.style.display = 'block';
        el.style.background = isError ? '#f8d7da' : '#d4edda';
        el.style.border = isError ? '1px solid #f5c6cb' : '1px solid #c3e6cb';
        el.style.color = isError ? '#721c24' : '#155724';
        el.textContent = message;

        if (!isError) {
            billingAdminMessageTimer = setTimeout(() => {
                const msgEl = document.getElementById('billing-admin-message');
                if (msgEl) msgEl.style.display = 'none';
                billingAdminMessageTimer = null;
            }, 4000);
        }
    }

    function onBillingRateScopeChange() {
        const scope = document.getElementById('billing-rate-scope');
        const row = document.getElementById('billing-rate-tenant-row');
        if (!scope || !row) return;
        row.style.display = scope.value === 'tenant' ? 'block' : 'none';
    }

    async function populateBillingAdminTenants() {
        if (billingAdminTenantsPopulated) return;
        const creditTenantDropdown = document.getElementById('billing-admin-credit-tenant');
        const creditHistoryTenantDropdown = document.getElementById('billing-admin-credit-history-tenant');
        const rateTenantDropdown = document.getElementById('billing-rate-tenant');
        if (!creditTenantDropdown || !creditHistoryTenantDropdown || !rateTenantDropdown) return;

        try {
            const tenants = await fetchWithAuth('/demo/generate_tenants').then(r => r.json());
            upsertTenantDisplayMapFromList(tenants);
            tenants.forEach(t => {
                const label = tenantDisplayNameFromObj(t);
                const creditOption = document.createElement('option');
                creditOption.value = t.name;
                creditOption.textContent = label;
                creditTenantDropdown.appendChild(creditOption);

                const historyOption = document.createElement('option');
                historyOption.value = t.name;
                historyOption.textContent = label;
                creditHistoryTenantDropdown.appendChild(historyOption);

                const rateOption = document.createElement('option');
                rateOption.value = t.name;
                rateOption.textContent = label;
                rateTenantDropdown.appendChild(rateOption);
            });

            if (!creditTenantDropdown.value && creditTenantDropdown.options.length > 1) {
                creditTenantDropdown.selectedIndex = 1;
            }
            billingAdminTenantsPopulated = true;
        } catch (error) {
            console.error('Failed to populate Billing Admin tenants:', error);
        }
    }

    async function initBillingAdminAccess() {
        if (billingAdminAccessReady) return;
        if (billingAdminAccessPromise) return billingAdminAccessPromise;
        billingAdminAccessPromise = _initBillingAdminAccessImpl();
        return billingAdminAccessPromise;
    }

    async function _initBillingAdminAccessImpl() {

        const tabBtn = document.getElementById('billing-admin-tab-btn');
        const content = document.getElementById('billing-admin-content');
        const noAccess = document.getElementById('billing-admin-no-access');

        try {
            const roles = await fetchWithAuth('/demo/generate_roles').then(r => r.json());
            billingAdminIsInferxAdmin = IsInferxAdmin(roles);
        } catch (error) {
            console.error('Failed to check Billing Admin access:', error);
            billingAdminIsInferxAdmin = false;
        }

        if (tabBtn) {
            tabBtn.style.display = billingAdminIsInferxAdmin ? '' : 'none';
        }
        if (content) {
            content.style.display = billingAdminIsInferxAdmin ? 'block' : 'none';
        }
        if (noAccess) {
            noAccess.style.display = billingAdminIsInferxAdmin ? 'none' : 'block';
        }

        if (!billingAdminIsInferxAdmin && localStorage.getItem('currentTab') === 'BillingAdmin') {
            const fallback = document.querySelector(`button[onclick*="'Billing'"]`) ||
                document.querySelector(`button[onclick*="'Apikeys'"]`);
            if (fallback) {
                openTab({ currentTarget: fallback }, fallback.getAttribute('onclick').includes("'Billing'") ? 'Billing' : 'Apikeys');
            }
        }

        if (billingAdminIsInferxAdmin) {
            await populateBillingAdminTenants();
            const effectiveFromInput = document.getElementById('billing-rate-effective-from');
            if (effectiveFromInput && !effectiveFromInput.value) {
                effectiveFromInput.value = toLocalDatetimeValue(new Date());
            }
            onBillingRateScopeChange();
        }

        billingAdminAccessReady = true;
    }

    function updateUsageRangeButtons() {
        const btn24 = document.getElementById('usage-range-24h');
        const btn7d = document.getElementById('usage-range-7d');
        const btn30d = document.getElementById('usage-range-30d');
        const btnCustom = document.getElementById('usage-range-custom');
        if (!btn24 || !btn7d || !btn30d || !btnCustom) return;

        btn24.classList.remove('active-range');
        btn7d.classList.remove('active-range');
        btn30d.classList.remove('active-range');
        btnCustom.classList.remove('active-range');

        if (billingUsageRange.mode === 'hours') {
            if (billingUsageRange.hours === 24) btn24.classList.add('active-range');
            if (billingUsageRange.hours === 24 * 7) btn7d.classList.add('active-range');
            if (billingUsageRange.hours === 24 * 30) btn30d.classList.add('active-range');
        } else if (billingUsageRange.mode === 'custom') {
            btnCustom.classList.add('active-range');
        }
    }

    function setUsageRangeHours(hours) {
        billingUsageRange = { mode: 'hours', hours: hours };
        const customEl = document.getElementById('billing-custom-range');
        if (customEl) {
            customEl.style.display = 'none';
        }
        updateUsageRangeButtons();
        updateAnalyticsRangeButtons();
        const tenant = document.getElementById('billing_tenant_select').value;
        if (tenant) {
            loadUsageChart(tenant);
        }
    }

    function syncBillingCustomRangeFromInputs(showAlerts = false) {
        const startInput = document.getElementById('billing-usage-start');
        const endInput = document.getElementById('billing-usage-end');
        if (!startInput || !endInput) return false;

        if (!startInput.value || !endInput.value) {
            if (showAlerts) alert('Please select both start and end time (Local)');
            return false;
        }

        const start = new Date(startInput.value);
        const end = new Date(endInput.value);
        if (isNaN(start.getTime()) || isNaN(end.getTime())) {
            if (showAlerts) alert('Invalid date range');
            return false;
        }

        if (end <= start) {
            if (showAlerts) alert('End time must be after start time');
            return false;
        }

        const maxRangeMs = 90 * 24 * 60 * 60 * 1000;
        if (end.getTime() - start.getTime() > maxRangeMs) {
            if (showAlerts) alert('Custom range is limited to 90 days');
            return false;
        }

        billingUsageRange = {
            mode: 'custom',
            start: start.toISOString(),
            end: end.toISOString()
        };
        return true;
    }

    function setDefaultBillingCustomRangeInputs() {
        const startInput = document.getElementById('billing-usage-start');
        const endInput = document.getElementById('billing-usage-end');
        if (!startInput || !endInput) return;

        if (!startInput.value || !endInput.value) {
            const end = new Date();
            const start = new Date(end.getTime() - 24 * 60 * 60 * 1000);
            startInput.value = toLocalDatetimeValue(start);
            endInput.value = toLocalDatetimeValue(end);
        }
    }

    function showBillingCustomRange() {
        const customEl = document.getElementById('billing-custom-range');
        if (customEl) {
            customEl.style.display = 'flex';
        }
        setDefaultBillingCustomRangeInputs();
        syncBillingCustomRangeFromInputs(false);
        updateUsageRangeButtons();
    }

    function applyBillingCustomRange() {
        if (!syncBillingCustomRangeFromInputs(true)) return;

        const customEl = document.getElementById('billing-custom-range');
        if (customEl) {
            customEl.style.display = 'flex';
        }
        updateUsageRangeButtons();
        const tenant = document.getElementById('billing_tenant_select').value;
        if (tenant) {
            loadUsageChart(tenant);
        }
    }

    function updateUsageViewButtons() {
        const chartBtn = document.getElementById('usage-view-chart');
        const tableBtn = document.getElementById('usage-view-table');
        if (!chartBtn || !tableBtn) return;

        chartBtn.classList.toggle('active-range', billingUsageViewMode === 'chart');
        tableBtn.classList.toggle('active-range', billingUsageViewMode === 'table');
    }

    function applyUsageViewVisibility() {
        const chartViewEl = document.getElementById('usage-chart-view');
        const tableViewEl = document.getElementById('usage-table-container');
        if (!chartViewEl || !tableViewEl) return;

        const showTable = billingUsageViewMode === 'table' && billingUsageTableReady;
        chartViewEl.style.display = showTable ? 'none' : 'block';
        tableViewEl.style.display = showTable ? 'block' : 'none';
    }

    function setUsageViewMode(mode) {
        billingUsageViewMode = mode === 'table' ? 'table' : 'chart';
        updateUsageViewButtons();
        applyUsageViewVisibility();
    }

    function getBillingUsageGranularityLabel(granularity) {
        switch (granularity) {
            case 'daily':
                return 'Daily';
            case 'weekly':
                return 'Weekly';
            case 'hourly':
            default:
                return 'Hourly';
        }
    }

    function updateUsageGranularityButtons() {
        const hourlyBtn = document.getElementById('usage-granularity-hourly');
        const dailyBtn = document.getElementById('usage-granularity-daily');
        const weeklyBtn = document.getElementById('usage-granularity-weekly');
        if (!hourlyBtn || !dailyBtn || !weeklyBtn) return;

        hourlyBtn.classList.toggle('active-range', billingUsageGranularity === 'hourly');
        dailyBtn.classList.toggle('active-range', billingUsageGranularity === 'daily');
        weeklyBtn.classList.toggle('active-range', billingUsageGranularity === 'weekly');
    }

    function setUsageGranularity(granularity) {
        if (granularity !== 'hourly' && granularity !== 'daily' && granularity !== 'weekly') return;
        billingUsageGranularity = granularity;
        updateUsageGranularityButtons();

        if (billingUsageRawRows.length > 0) {
            renderBillingUsageFromRawRows();
            return;
        }

        const tenant = document.getElementById('billing_tenant_select').value;
        if (tenant) loadUsageChart(tenant);
    }

    function updateAnalyticsRangeButtons() {
        const btn24 = document.getElementById('analytics-range-24h');
        const btn7d = document.getElementById('analytics-range-7d');
        const btn30d = document.getElementById('analytics-range-30d');
        if (!btn24 || !btn7d || !btn30d) return;

        btn24.classList.remove('active-range');
        btn7d.classList.remove('active-range');
        btn30d.classList.remove('active-range');

        if (analyticsUsageRange && analyticsUsageRange.mode === 'hours') {
            if (analyticsUsageRange.hours === 24) btn24.classList.add('active-range');
            if (analyticsUsageRange.hours === 24 * 7) btn7d.classList.add('active-range');
            if (analyticsUsageRange.hours === 24 * 30) btn30d.classList.add('active-range');
        }
    }

    function setAnalyticsRangeHours(hours) {
        analyticsUsageRange = { mode: 'hours', hours: hours };
        const rangeSelect = document.getElementById('analytics-time-range');
        if (rangeSelect) {
            rangeSelect.value = String(hours);
        }
        const customEl = document.getElementById('analytics-custom-range');
        if (customEl) {
            customEl.style.display = 'none';
        }
        updateAnalyticsRangeButtons();
        if (analyticsExpanded) {
            loadAnalytics();
        }
    }

    function syncAnalyticsCustomRangeFromInputs(showAlerts = false) {
        const startInput = document.getElementById('usage-start');
        const endInput = document.getElementById('usage-end');
        if (!startInput || !endInput) return false;

        if (!startInput.value || !endInput.value) {
            if (showAlerts) alert('Please select both start and end time (Local)');
            return false;
        }

        const start = new Date(startInput.value);
        const end = new Date(endInput.value);

        if (isNaN(start.getTime()) || isNaN(end.getTime())) {
            if (showAlerts) alert('Invalid date range');
            return false;
        }

        if (end <= start) {
            if (showAlerts) alert('End time must be after start time');
            return false;
        }

        const maxRangeMs = 90 * 24 * 60 * 60 * 1000; // 90 days
        if (end.getTime() - start.getTime() > maxRangeMs) {
            if (showAlerts) alert('Custom range is limited to 90 days');
            return false;
        }

        analyticsUsageRange = {
            mode: 'custom',
            start: start.toISOString(),
            end: end.toISOString()
        };
        return true;
    }

    function applyCustomUsageRange() {
        if (!syncAnalyticsCustomRangeFromInputs(true)) return;

        const rangeSelect = document.getElementById('analytics-time-range');
        if (rangeSelect) {
            rangeSelect.value = 'custom';
        }
        const customEl = document.getElementById('analytics-custom-range');
        if (customEl) {
            customEl.style.display = 'flex';
        }
        updateAnalyticsRangeButtons();
        const tenant = document.getElementById('billing_tenant_select').value;
        if (tenant && analyticsExpanded) {
            loadAnalytics();
        }
    }

    function setDefaultCustomRangeInputs() {
        const startInput = document.getElementById('usage-start');
        const endInput = document.getElementById('usage-end');
        if (!startInput || !endInput) return;

        if (!startInput.value || !endInput.value) {
            const end = new Date();
            const start = new Date(end.getTime() - 24 * 60 * 60 * 1000);
            startInput.value = toLocalDatetimeValue(start);
            endInput.value = toLocalDatetimeValue(end);
        }

        // Keep custom-range state in sync even before explicit "Apply".
        syncAnalyticsCustomRangeFromInputs(false);
    }

    function toLocalDatetimeValue(date) {
        const tzOffsetMs = date.getTimezoneOffset() * 60 * 1000;
        const local = new Date(date.getTime() - tzOffsetMs);
        return local.toISOString().slice(0, 16);
    }

    // Called when tenant selection changes
    async function loadBillingData() {
        const tenant = document.getElementById('billing_tenant_select').value;

        // Handle no selection
        if (!tenant) {
            document.getElementById('billing-no-tenant').style.display = 'block';
            document.getElementById('billing-content').style.display = 'none';
            return;
        }

        document.getElementById('billing-no-tenant').style.display = 'none';
        document.getElementById('billing-content').style.display = 'block';

        updateUsageRangeButtons();
        const billingCustomRangeEl = document.getElementById('billing-custom-range');
        if (billingCustomRangeEl) {
            billingCustomRangeEl.style.display = billingUsageRange.mode === 'custom' ? 'flex' : 'none';
        }
        if (billingUsageRange.mode === 'custom') {
            setDefaultBillingCustomRangeInputs();
        }
        updateUsageViewButtons();
        updateUsageGranularityButtons();
        applyUsageViewVisibility();
        updateAnalyticsRangeButtons();

        // Load all data in parallel
        await Promise.all([
            loadBillingSummary(tenant),
            loadUsageChart(tenant),
            loadCreditHistory(tenant, 0)
        ]);

        // Keep analytics panel in sync when tenant changes.
        if (analyticsExpanded) {
            loadAnalytics();
        }
    }

    // Check if user is InferxAdmin (system tenant admin)
    function IsInferxAdmin(roles) {
        if (!roles || !Array.isArray(roles)) return false;

        return roles.some(rb => {
            const rbObjType = String(rb.objType).toLowerCase().trim();
            const rbRole = String(rb.role).toLowerCase().trim();
            const rbTenant = String(rb.tenant).toLowerCase().trim();

            return rbObjType === "tenant" &&
                   rbTenant === "system" &&
                   rbRole === "admin";
        });
    }

    async function loadBillingSummary(tenant) {
        try {
            // Try billing-summary endpoint first (Phase 3), fall back to credits + tenant status (Phase 1)
            let data;
            let hasBillingSummary = false;
            let tenantStatus = null;

            try {
                const summaryResp = await fetchWithAuth(`/demo/proxy1/tenant/${tenant}/billing-summary`);
                if (summaryResp.ok) {
                    data = await summaryResp.json();
                    hasBillingSummary = true;
                }
            } catch (e) {
                // billing-summary not available, fall back to credits
            }

            if (!hasBillingSummary) {
                // Phase 1 fallback: use existing /credits endpoint + tenant object for status
                const [creditsResp, tenantResp] = await Promise.all([
                    fetchWithAuth(`/demo/proxy1/tenant/${tenant}/credits`),
                    fetchWithAuth(`/demo/proxy1/object/tenant/system/system/${tenant}/`)
                ]);

                if (!creditsResp.ok) throw new Error(`Credits HTTP ${creditsResp.status}`);
                data = await creditsResp.json();

                // Try to get quota_exceeded from tenant object
                if (tenantResp.ok) {
                    try {
                        const tenantObj = await tenantResp.json();
                        tenantStatus = tenantObj.object?.status || tenantObj.status || null;
                    } catch (e) {
                        console.warn('Failed to parse tenant object:', e);
                    }
                }
            }

            // Balance (available in both endpoints)
            const balanceCents = data.balance_cents || 0;
            const balanceEl = document.getElementById('balance-value');
            balanceEl.textContent = formatUsdSigned(balanceCents);
            balanceEl.classList.toggle('amount-negative', balanceCents < 0);
            document.getElementById('balance-subtext').textContent = '';

            if (hasBillingSummary) {
                // Full data from billing-summary
                const usedCents = data.used_cents || 0;
                document.getElementById('used-value').textContent = formatUsd(usedCents);

                const infCents = data.period?.inference_cents || 0;
                const sbyCents = data.period?.standby_cents || 0;
                document.getElementById('used-breakdown').innerHTML =
                    `<span>Inf: ${formatUsd(infCents)}</span> | <span>Sby: ${formatUsd(sbyCents)}</span>`;

                const thresholdCents = data.threshold_cents || 0;
                document.getElementById('threshold-value').textContent = formatUsd(thresholdCents);

                // Status - use quota_exceeded from server
                const statusEl = document.getElementById('status-value');
                if (data.quota_exceeded) {
                    statusEl.textContent = '● Quota Exceeded';
                    statusEl.className = 'status-exceeded';
                } else {
                    statusEl.textContent = '● Active';
                    statusEl.className = 'status-active';
                }
            } else {
                // Fallback: use existing /credits endpoint + tenant object for status
                document.getElementById('used-value').textContent = '--';
                document.getElementById('used-breakdown').textContent = '';
                document.getElementById('threshold-value').textContent = '--';

                // Get status from tenant object
                const statusEl = document.getElementById('status-value');
                if (tenantStatus) {
                    if (tenantStatus.quota_exceeded === true) {
                        statusEl.textContent = '● Quota Exceeded';
                        statusEl.className = 'status-exceeded';
                    } else {
                        statusEl.textContent = '● Active';
                        statusEl.className = 'status-active';
                    }
                } else {
                    statusEl.textContent = '● Unknown';
                    statusEl.className = '';
                }
            }
        } catch (error) {
            console.error('Failed to load billing summary:', error);
            // Show error state
            const balanceEl = document.getElementById('balance-value');
            balanceEl.textContent = 'Error';
            balanceEl.classList.remove('amount-negative');
            document.getElementById('used-value').textContent = 'Error';
            document.getElementById('threshold-value').textContent = 'Error';
            document.getElementById('status-value').textContent = '● Unknown';
        }
    }

    function formatBillingUsagePeriodLabel(row, granularity, mode) {
        const currentMode = mode || 'table';
        const start = new Date(row.hour);
        if (granularity === 'weekly') {
            const end = row.week_end ? new Date(row.week_end) : new Date(start.getTime());
            if (!row.week_end) end.setDate(end.getDate() + 6);
            if (currentMode === 'axis') {
                return start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            const startLabel = start.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
            const endLabel = end.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
            return `${startLabel} - ${endLabel}`;
        }

        if (granularity === 'daily') {
            return currentMode === 'table'
                ? start.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' })
                : start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        if (currentMode === 'axis') {
            return start.getHours().toString().padStart(2, '0');
        }
        if (currentMode === 'tooltip') {
            return `${start.getHours().toString().padStart(2, '0')}:00`;
        }
        return start.toLocaleString(undefined, {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
    }

    function renderBillingUsageFromRawRows() {
        const chartEl = document.getElementById('usage-chart');
        const labelsEl = document.getElementById('usage-chart-labels');
        if (!chartEl || !labelsEl) return;
        if (!Array.isArray(billingUsageRawRows) || billingUsageRawRows.length === 0) return;

        const granularity = billingUsageGranularity;
        const displayData = granularity === 'hourly'
            ? [...billingUsageRawRows]
            : aggregateHourlyUsageByGranularity(billingUsageRawRows, granularity);

        const maxCents = Math.max(...displayData.map(u =>
            (u.inference_cents || 0) + (u.standby_cents || 0)
        ), 1);

        chartEl.innerHTML = displayData.map(u => {
            const infCents = u.inference_cents || 0;
            const sbyCents = u.standby_cents || 0;
            const infMs = u.inference_ms || 0;
            const sbyMs = u.standby_ms || 0;
            const totalCents = infCents + sbyCents;
            const totalHeight = Math.max(2, (totalCents / maxCents) * 100);

            const infPct = totalCents > 0 ? (infCents / totalCents) * 100 : 0;
            const sbyPct = totalCents > 0 ? (sbyCents / totalCents) * 100 : 0;
            const infHrs = (infMs / 3600000).toFixed(2);
            const sbyHrs = (sbyMs / 3600000).toFixed(2);
            const periodLabel = formatBillingUsagePeriodLabel(u, granularity, 'tooltip');
            const tooltip = `${periodLabel} | Inference: ${formatUsd(infCents)} (${infHrs} hrs) | Standby: ${formatUsd(sbyCents)} (${sbyHrs} hrs) | Total: ${formatUsd(totalCents)}`;

            return `<div class="usage-bar-stack" style="height: ${totalHeight}%" title="${tooltip}">` +
                `<div class="usage-bar-inference" style="height: ${infPct}%"></div>` +
                `<div class="usage-bar-standby" style="height: ${sbyPct}%"></div>` +
                `</div>`;
        }).join('');

        const labelEvery = Math.max(1, Math.ceil(displayData.length / 6));
        labelsEl.innerHTML = displayData.map((u, i) => {
            const label = (i % labelEvery === 0)
                ? formatBillingUsagePeriodLabel(u, granularity, 'axis')
                : '';
            return `<div style="flex: 1; text-align: center;">${label}</div>`;
        }).join('');

        renderUsageTable(displayData, granularity);
        billingUsageTableReady = true;
        applyUsageViewVisibility();
    }

    async function loadUsageChart(tenant) {
        const chartEl = document.getElementById('usage-chart');
        const labelsEl = document.getElementById('usage-chart-labels');

        try {
            const params = new URLSearchParams();
            if (billingUsageRange.mode === 'custom') {
                if (
                    !billingUsageRange.start ||
                    !billingUsageRange.end
                ) {
                    if (!syncBillingCustomRangeFromInputs(false)) {
                        params.set('hours', '24');
                    } else {
                        params.set('start', billingUsageRange.start);
                        params.set('end', billingUsageRange.end);
                    }
                } else {
                    params.set('start', billingUsageRange.start);
                    params.set('end', billingUsageRange.end);
                }
            } else {
                params.set('hours', String(billingUsageRange.hours || 24));
            }
            const resp = await fetchWithAuth(`/demo/proxy1/tenant/${tenant}/usage/hourly?${params.toString()}`);

            if (resp.status === 404) {
                billingUsageRawRows = [];
                billingUsageTableRows = [];
                chartEl.innerHTML = '<div style="color: #888; padding: 20px;">Usage chart available in Phase 3</div>';
                labelsEl.innerHTML = '';
                billingUsageTableReady = false;
                applyUsageViewVisibility();
                return;
            }

            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();

            if (!data.usage || data.usage.length === 0) {
                billingUsageRawRows = [];
                billingUsageTableRows = [];
                chartEl.innerHTML = '<div style="color: #888; padding: 20px;">No usage data</div>';
                labelsEl.innerHTML = '';
                billingUsageTableReady = false;
                applyUsageViewVisibility();
                return;
            }

            billingUsageRawRows = Array.isArray(data.usage) ? data.usage : [];
            renderBillingUsageFromRawRows();
        } catch (error) {
            console.error('Failed to load usage chart:', error);
            billingUsageRawRows = [];
            billingUsageTableRows = [];
            chartEl.innerHTML = '<div style="color: #888; padding: 20px;">Usage chart unavailable</div>';
            labelsEl.innerHTML = '';
            billingUsageTableReady = false;
            applyUsageViewVisibility();
        }
    }

    function renderUsageTable(displayData, granularity) {
        const usageTableGranularityEl = document.getElementById('usage-table-granularity');
        const usageTableBodyEl = document.querySelector('#usage-table tbody');
        if (!usageTableGranularityEl || !usageTableBodyEl) return;

        billingUsageTableRows = Array.isArray(displayData) ? displayData : [];
        billingUsageTableGranularity = granularity || 'hourly';
        usageTableGranularityEl.textContent = getBillingUsageGranularityLabel(billingUsageTableGranularity);

        const sortedRows = [...billingUsageTableRows].sort((a, b) => {
            let aVal;
            let bVal;
            switch (billingUsageSortColumn) {
                case 'inf_cost':
                    aVal = a.inference_cents || 0;
                    bVal = b.inference_cents || 0;
                    break;
                case 'sby_cost':
                    aVal = a.standby_cents || 0;
                    bVal = b.standby_cents || 0;
                    break;
                case 'total_cost':
                    aVal = (a.inference_cents || 0) + (a.standby_cents || 0);
                    bVal = (b.inference_cents || 0) + (b.standby_cents || 0);
                    break;
                case 'inf_hours':
                    aVal = a.inference_ms || 0;
                    bVal = b.inference_ms || 0;
                    break;
                case 'sby_hours':
                    aVal = a.standby_ms || 0;
                    bVal = b.standby_ms || 0;
                    break;
                case 'period':
                default:
                    aVal = Date.parse(a.hour) || 0;
                    bVal = Date.parse(b.hour) || 0;
                    break;
            }
            return billingUsageSortDirection === 'asc' ? (aVal - bVal) : (bVal - aVal);
        });

        let totalInfCents = 0;
        let totalSbyCents = 0;
        let totalInfHours = 0;
        let totalSbyHours = 0;

        usageTableBodyEl.innerHTML = sortedRows.map(u => {
            const infCents = u.inference_cents || 0;
            const sbyCents = u.standby_cents || 0;
            const infHours = (u.inference_ms || 0) / 3600000;
            const sbyHours = (u.standby_ms || 0) / 3600000;
            const totalCents = infCents + sbyCents;
            const periodLabel = formatBillingUsagePeriodLabel(
                u,
                billingUsageTableGranularity,
                'table'
            );

            totalInfCents += infCents;
            totalSbyCents += sbyCents;
            totalInfHours += infHours;
            totalSbyHours += sbyHours;

            return `
                <tr>
                    <td style="text-align: left;">${periodLabel}</td>
                    <td style="text-align: right;">${infHours.toFixed(2)}</td>
                    <td style="text-align: right;">${sbyHours.toFixed(2)}</td>
                    <td style="text-align: right;">${formatUsd(infCents)}</td>
                    <td style="text-align: right;">${formatUsd(sbyCents)}</td>
                    <td style="text-align: right;">${formatUsd(totalCents)}</td>
                </tr>
            `;
        }).join('');

        document.getElementById('usage-table-total-inf-hours').textContent = totalInfHours.toFixed(2);
        document.getElementById('usage-table-total-sby-hours').textContent = totalSbyHours.toFixed(2);
        document.getElementById('usage-table-total-inf-cost').textContent = formatUsd(totalInfCents);
        document.getElementById('usage-table-total-sby-cost').textContent = formatUsd(totalSbyCents);
        document.getElementById('usage-table-total-cost').textContent = formatUsd(totalInfCents + totalSbyCents);

        const setUsageSortIcon = (id, column) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = billingUsageSortColumn === column
                ? (billingUsageSortDirection === 'asc' ? '▲' : '▼')
                : '';
        };
        setUsageSortIcon('usage-sort-period-icon', 'period');
        setUsageSortIcon('usage-sort-inf-hours-icon', 'inf_hours');
        setUsageSortIcon('usage-sort-sby-hours-icon', 'sby_hours');
        setUsageSortIcon('usage-sort-inf-cost-icon', 'inf_cost');
        setUsageSortIcon('usage-sort-sby-cost-icon', 'sby_cost');
        setUsageSortIcon('usage-sort-total-cost-icon', 'total_cost');
    }

    function sortUsageTable(column) {
        if (billingUsageSortColumn === column) {
            billingUsageSortDirection = billingUsageSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            billingUsageSortColumn = column;
            billingUsageSortDirection = 'desc';
        }
        renderUsageTable(billingUsageTableRows, billingUsageTableGranularity);
    }

    function renderCreditHistoryTable(records) {
        const tbody = document.querySelector('#credit-history-table tbody');
        if (!tbody) return;

        billingCreditHistoryRows = Array.isArray(records) ? records : [];
        if (billingCreditHistoryRows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888;">No credit history</td></tr>';
        } else {
            const sortedRows = [...billingCreditHistoryRows].sort((a, b) => {
                let aVal;
                let bVal;
                switch (billingCreditSortColumn) {
                    case 'amount':
                        aVal = a.amount_cents || 0;
                        bVal = b.amount_cents || 0;
                        break;
                    case 'note':
                        aVal = (a.note || '').toLowerCase();
                        bVal = (b.note || '').toLowerCase();
                        return billingCreditSortDirection === 'asc'
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);
                    case 'payment_ref':
                        aVal = (a.payment_ref || '').toLowerCase();
                        bVal = (b.payment_ref || '').toLowerCase();
                        return billingCreditSortDirection === 'asc'
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);
                    case 'added_by':
                        aVal = (a.added_by || '').toLowerCase();
                        bVal = (b.added_by || '').toLowerCase();
                        return billingCreditSortDirection === 'asc'
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);
                    case 'date':
                    default:
                        aVal = Date.parse(a.created_at) || 0;
                        bVal = Date.parse(b.created_at) || 0;
                        break;
                }
                return billingCreditSortDirection === 'asc' ? (aVal - bVal) : (bVal - aVal);
            });

            tbody.innerHTML = sortedRows.map(record => {
                const date = new Date(record.created_at).toLocaleString();
                const cents = record.amount_cents || 0;
                let amountClass;
                let amountText;
                if (cents > 0) {
                    amountClass = 'amount-positive';
                    amountText = '+' + formatUsd(cents);
                } else if (cents < 0) {
                    amountClass = 'amount-negative';
                    amountText = '-' + formatUsd(Math.abs(cents));
                } else {
                    amountClass = 'amount-zero';
                    amountText = formatUsd(0);
                }

                return `
                    <tr>
                        <td>${date}</td>
                        <td class="${amountClass}">${amountText}</td>
                        <td>${record.note || '-'}</td>
                        <td>${record.payment_ref || '-'}</td>
                        <td>${record.added_by || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        const setCreditSortIcon = (id, column) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = billingCreditSortColumn === column
                ? (billingCreditSortDirection === 'asc' ? '▲' : '▼')
                : '';
        };
        setCreditSortIcon('credit-sort-date-icon', 'date');
        setCreditSortIcon('credit-sort-amount-icon', 'amount');
        setCreditSortIcon('credit-sort-note-icon', 'note');
        setCreditSortIcon('credit-sort-payment-ref-icon', 'payment_ref');
        setCreditSortIcon('credit-sort-added-by-icon', 'added_by');
    }

    function sortCreditHistoryTable(column) {
        if (billingCreditSortColumn === column) {
            billingCreditSortDirection = billingCreditSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            billingCreditSortColumn = column;
            billingCreditSortDirection = column === 'date' ? 'desc' : 'asc';
        }
        renderCreditHistoryTable(billingCreditHistoryRows);
    }

    async function loadCreditHistory(tenant, page) {
        billingCurrentPage = page;
        const offset = page * billingPageSize;

        try {
            const resp = await fetchWithAuth(`/demo/proxy1/tenant/${tenant}/credits/history?limit=${billingPageSize}&offset=${offset}`);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();

            billingCreditHistoryRows = Array.isArray(data.records) ? data.records : [];
            renderCreditHistoryTable(billingCreditHistoryRows);

            // Update pagination
            // Phase 1 fallback: if `total` not in response, use records.length to determine hasNext
            const hasTotal = typeof data.total === 'number';
            const total = data.total || 0;
            const recordCount = data.records ? data.records.length : 0;

            if (hasTotal) {
                // Phase 3: Use total for accurate pagination
                billingTotalPages = Math.max(1, Math.ceil(total / billingPageSize));
                document.getElementById('billing-page-info').textContent = `Page ${page + 1} of ${billingTotalPages}`;
            } else {
                // Phase 1 fallback: Show page number only, estimate hasNext from record count
                billingTotalPages = (recordCount === billingPageSize) ? page + 2 : page + 1;
                document.getElementById('billing-page-info').textContent = `Page ${page + 1}`;
            }

            // Enable/disable pagination buttons
            document.getElementById('prev-page-btn').disabled = (page <= 0);
            document.getElementById('next-page-btn').disabled = hasTotal
                ? (page >= billingTotalPages - 1)
                : (recordCount < billingPageSize); // Phase 1: disable if fewer records than page size

        } catch (error) {
            console.error('Failed to load credit history:', error);
            billingCreditHistoryRows = [];
            const tbody = document.querySelector('#credit-history-table tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Failed to load credit history</td></tr>';
        }
    }

    function billingPrevPage() {
        if (billingCurrentPage > 0) {
            const tenant = document.getElementById('billing_tenant_select').value;
            loadCreditHistory(tenant, billingCurrentPage - 1);
        }
    }

    function billingNextPage() {
        if (billingCurrentPage < billingTotalPages - 1) {
            const tenant = document.getElementById('billing_tenant_select').value;
            loadCreditHistory(tenant, billingCurrentPage + 1);
        }
    }

    async function toggleBillingAdminCreditHistory() {
        billingAdminCreditHistoryExpanded = !billingAdminCreditHistoryExpanded;
        document.getElementById('billing-admin-credit-history-content').style.display =
            billingAdminCreditHistoryExpanded ? 'block' : 'none';
        document.getElementById('billing-admin-credit-toggle-icon').textContent =
            billingAdminCreditHistoryExpanded ? '▼' : '▶';

        if (billingAdminCreditHistoryExpanded) {
            await loadBillingAdminCreditHistory(billingAdminCreditHistoryPage);
        }
    }

    async function toggleBillingAdminRateHistory() {
        billingAdminRateHistoryExpanded = !billingAdminRateHistoryExpanded;
        document.getElementById('billing-admin-rate-history-content').style.display =
            billingAdminRateHistoryExpanded ? 'block' : 'none';
        document.getElementById('billing-admin-rate-toggle-icon').textContent =
            billingAdminRateHistoryExpanded ? '▼' : '▶';

        if (billingAdminRateHistoryExpanded) {
            await loadBillingAdminRateHistory(billingAdminRateHistoryPage);
        }
    }

    async function loadBillingAdminCreditHistory(page) {
        const tenant = document.getElementById('billing-admin-credit-history-tenant').value || 'all';
        const tbody = document.querySelector('#billing-admin-credit-history-table tbody');
        const prevBtn = document.getElementById('billing-admin-credit-prev-page-btn');
        const nextBtn = document.getElementById('billing-admin-credit-next-page-btn');
        const pageInfo = document.getElementById('billing-admin-credit-page-info');

        billingAdminCreditHistoryPage = page;
        const offset = page * billingAdminCreditHistoryPageSize;

        try {
            const params = new URLSearchParams();
            params.set('limit', String(billingAdminCreditHistoryPageSize));
            params.set('offset', String(offset));
            if (tenant !== 'all') {
                params.set('tenant', tenant);
            }
            const resp = await fetchWithAuth(`/demo/proxy1/billing/credits/history?${params.toString()}`);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();

            tbody.innerHTML = '';
            if (data.records && data.records.length > 0) {
                data.records.forEach(record => {
                    const row = document.createElement('tr');
                    const date = new Date(record.created_at).toLocaleString();
                    const cents = record.amount_cents || 0;
                    let amountClass, amountText;
                    if (cents > 0) {
                        amountClass = 'amount-positive';
                        amountText = '+' + formatUsd(cents);
                    } else if (cents < 0) {
                        amountClass = 'amount-negative';
                        amountText = '-' + formatUsd(Math.abs(cents));
                    } else {
                        amountClass = 'amount-zero';
                        amountText = formatUsd(0);
                    }

                    row.innerHTML = `
                        <td>${record.tenant || '-'}</td>
                        <td>${date}</td>
                        <td class="${amountClass}">${amountText}</td>
                        <td>${record.note || '-'}</td>
                        <td>${record.payment_ref || '-'}</td>
                        <td>${record.added_by || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888;">No credit history</td></tr>';
            }

            const hasTotal = typeof data.total === 'number';
            const total = data.total || 0;
            const recordCount = data.records ? data.records.length : 0;

            if (hasTotal) {
                billingAdminCreditHistoryTotalPages = Math.max(1, Math.ceil(total / billingAdminCreditHistoryPageSize));
                pageInfo.textContent = `Page ${page + 1} of ${billingAdminCreditHistoryTotalPages}`;
            } else {
                billingAdminCreditHistoryTotalPages = (recordCount === billingAdminCreditHistoryPageSize) ? page + 2 : page + 1;
                pageInfo.textContent = `Page ${page + 1}`;
            }

            prevBtn.disabled = (page <= 0);
            nextBtn.disabled = hasTotal
                ? (page >= billingAdminCreditHistoryTotalPages - 1)
                : (recordCount < billingAdminCreditHistoryPageSize);
        } catch (error) {
            console.error('Failed to load Billing Admin credit history:', error);
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Failed to load credit history</td></tr>';
            if (prevBtn) prevBtn.disabled = true;
            if (nextBtn) nextBtn.disabled = true;
        }
    }

    function billingAdminCreditPrevPage() {
        if (billingAdminCreditHistoryPage > 0) {
            loadBillingAdminCreditHistory(billingAdminCreditHistoryPage - 1);
        }
    }

    function billingAdminCreditNextPage() {
        if (billingAdminCreditHistoryPage < billingAdminCreditHistoryTotalPages - 1) {
            loadBillingAdminCreditHistory(billingAdminCreditHistoryPage + 1);
        }
    }

    async function loadBillingAdminRateHistory(page) {
        const tbody = document.querySelector('#billing-admin-rate-history-table tbody');
        const prevBtn = document.getElementById('billing-admin-rate-prev-page-btn');
        const nextBtn = document.getElementById('billing-admin-rate-next-page-btn');
        const pageInfo = document.getElementById('billing-admin-rate-page-info');

        billingAdminRateHistoryPage = page;

        const params = new URLSearchParams();
        params.set('limit', String(billingAdminRateHistoryPageSize));
        params.set('offset', String(page * billingAdminRateHistoryPageSize));
        params.set('scope', 'all');

        try {
            const resp = await fetchWithAuth(`/demo/proxy1/billing/rates?${params.toString()}`);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();

            tbody.innerHTML = '';
            if (data.records && data.records.length > 0) {
                data.records.forEach(record => {
                    const row = document.createElement('tr');
                    const scopeText = record.tenant ? `Tenant: ${tenantDisplayLabel(record.tenant)}` : 'Global';
                    const rateText = `${formatUsd(record.rate_cents_per_hour)} (${record.rate_cents_per_hour}¢/GPU-hr)`;
                    const effectiveFrom = record.effective_from ? new Date(record.effective_from).toLocaleString() : '-';
                    const effectiveTo = record.effective_to ? new Date(record.effective_to).toLocaleString() : '-';
                    const createdAt = record.created_at ? new Date(record.created_at).toLocaleString() : '-';
                    const addedBy = record.added_by || '-';

                    row.innerHTML = `
                        <td>${record.id}</td>
                        <td>${scopeText}</td>
                        <td>${record.usage_type}</td>
                        <td>${rateText}</td>
                        <td>${effectiveFrom}</td>
                        <td>${effectiveTo}</td>
                        <td>${createdAt}</td>
                        <td>${addedBy}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #888;">No rate history</td></tr>';
            }

            const total = typeof data.total === 'number' ? data.total : 0;
            billingAdminRateHistoryTotalPages = Math.max(1, Math.ceil(total / billingAdminRateHistoryPageSize));
            pageInfo.textContent = `Page ${page + 1} of ${billingAdminRateHistoryTotalPages}`;
            prevBtn.disabled = (page <= 0);
            nextBtn.disabled = (page >= billingAdminRateHistoryTotalPages - 1);
        } catch (error) {
            console.error('Failed to load billing rate history:', error);
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Failed to load rate history</td></tr>';
            if (prevBtn) prevBtn.disabled = true;
            if (nextBtn) nextBtn.disabled = true;
        }
    }

    function billingAdminRatePrevPage() {
        if (billingAdminRateHistoryPage > 0) {
            loadBillingAdminRateHistory(billingAdminRateHistoryPage - 1);
        }
    }

    function billingAdminRateNextPage() {
        if (billingAdminRateHistoryPage < billingAdminRateHistoryTotalPages - 1) {
            loadBillingAdminRateHistory(billingAdminRateHistoryPage + 1);
        }
    }

    async function addCredits() {
        if (billingIsSubmitting) return; // Prevent double-submit

        const tenant = document.getElementById('billing-admin-credit-tenant').value;
        const amountInput = parseFloat(document.getElementById('billing-admin-credit-amount').value);
        const note = document.getElementById('billing-admin-credit-note').value;
        const paymentRef = document.getElementById('billing-admin-credit-payment-ref').value;

        if (!tenant) {
            showBillingAdminMessage('Please select a tenant.', true);
            return;
        }

        if (!Number.isFinite(amountInput) || amountInput === 0) {
            showBillingAdminMessage('Please enter a non-zero amount in USD. Use negative amount to deduct credits.', true);
            return;
        }

        const amountCents = Math.round(amountInput * 100);
        if (amountCents === 0) {
            showBillingAdminMessage('Amount is too small. Minimum absolute value is $0.01.', true);
            return;
        }
        const creditConfirm = window.confirm(
            `Confirm credit adjustment?\n` +
            `Tenant: ${tenantDisplayLabel(tenant)}\n` +
            `Amount: ${formatUsdSigned(amountCents)}\n` +
            `Note: ${note || '-'}\n` +
            `Payment Ref: ${paymentRef || '-'}`
        );
        if (!creditConfirm) {
            return;
        }

        const btn = document.getElementById('billing-admin-add-credits-btn');
        billingIsSubmitting = true;
        btn.disabled = true;
        btn.textContent = 'Adding...';

        try {
            const resp = await fetchWithAuth(`/demo/proxy1/tenant/${tenant}/credits`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    amount_cents: amountCents,
                    currency: 'USD',
                    note: note || null,
                    payment_ref: paymentRef || null
                })
            });

            if (resp.ok) {
                showBillingAdminMessage(`Credit adjustment applied: ${formatUsdSigned(amountCents)}.`, false);
                document.getElementById('billing-admin-credit-amount').value = '';
                document.getElementById('billing-admin-credit-note').value = '';
                document.getElementById('billing-admin-credit-payment-ref').value = '';

                if (billingAdminCreditHistoryExpanded) {
                    await loadBillingAdminCreditHistory(0);
                }

                const billingTenant = document.getElementById('billing_tenant_select').value;
                if (billingTenant === tenant) {
                    loadBillingData();
                }
            } else if (resp.status === 403) {
                showBillingAdminMessage('Permission denied. Only Inferx administrators can add credits.', true);
            } else {
                const error = await resp.text();
                showBillingAdminMessage('Failed to add credits: ' + error, true);
            }
        } catch (error) {
            showBillingAdminMessage('Error adding credits: ' + error, true);
        } finally {
            billingIsSubmitting = false;
            btn.disabled = false;
            btn.textContent = 'Add Credits';
        }
    }

    async function addBillingRate() {
        const btn = document.getElementById('billing-admin-add-rate-btn');
        const usageType = document.getElementById('billing-rate-usage-type').value;
        const rateCents = parseInt(document.getElementById('billing-rate-cents').value, 10);
        const scope = document.getElementById('billing-rate-scope').value;
        const rateTenant = document.getElementById('billing-rate-tenant').value;
        const effectiveFromInput = document.getElementById('billing-rate-effective-from').value;
        const effectiveToInput = document.getElementById('billing-rate-effective-to').value;

        if (!Number.isInteger(rateCents) || rateCents < 0) {
            showBillingAdminMessage('Rate must be a non-negative integer (cents/hour).', true);
            return;
        }

        if (scope === 'tenant' && !rateTenant) {
            showBillingAdminMessage('Please select a tenant for tenant override rate.', true);
            return;
        }

        let effectiveFromIso;
        if (effectiveFromInput) {
            const dt = new Date(effectiveFromInput);
            if (isNaN(dt.getTime())) {
                showBillingAdminMessage('Invalid Effective From datetime.', true);
                return;
            }
            effectiveFromIso = dt.toISOString();
        } else {
            effectiveFromIso = new Date().toISOString();
        }

        let effectiveToIso = null;
        if (effectiveToInput) {
            const dt = new Date(effectiveToInput);
            if (isNaN(dt.getTime())) {
                showBillingAdminMessage('Invalid Effective To datetime.', true);
                return;
            }
            effectiveToIso = dt.toISOString();
            if (new Date(effectiveToIso) <= new Date(effectiveFromIso)) {
                showBillingAdminMessage('Effective To must be after Effective From.', true);
                return;
            }
        }

        const rateScopeLabel = scope === 'tenant' ? `Tenant Override (${rateTenant})` : 'Global';
        const rateConfirm = window.confirm(
            `Confirm add billing rate?\n` +
            `Scope: ${rateScopeLabel}\n` +
            `Usage Type: ${usageType}\n` +
            `Rate: ${formatUsd(rateCents)}/GPU-hour (${rateCents}¢)\n` +
            `Effective From: ${new Date(effectiveFromIso).toLocaleString()}\n` +
            `Effective To: ${effectiveToIso ? new Date(effectiveToIso).toLocaleString() : 'Open-ended'}`
        );
        if (!rateConfirm) {
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Adding...';
        try {
            const resp = await fetchWithAuth('/demo/proxy1/billing/rates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    usage_type: usageType,
                    rate_cents_per_hour: rateCents,
                    effective_from: effectiveFromIso,
                    effective_to: effectiveToIso,
                    tenant: scope === 'tenant' ? rateTenant : null
                })
            });

            if (resp.ok) {
                const data = await resp.json();
                showBillingAdminMessage(`Billing rate added (id=${data.rate_id}).`, false);
                document.getElementById('billing-rate-cents').value = '';
                document.getElementById('billing-rate-effective-to').value = '';

                if (billingAdminRateHistoryExpanded) {
                    await loadBillingAdminRateHistory(0);
                }
            } else if (resp.status === 403) {
                showBillingAdminMessage('Permission denied. Only Inferx administrators can add rates.', true);
            } else {
                const error = await resp.text();
                showBillingAdminMessage('Failed to add rate: ' + error, true);
            }
        } catch (error) {
            showBillingAdminMessage('Error adding rate: ' + error, true);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Add Rate';
        }
    }

    // Helper: format cents as USD string (e.g. 1234 → "$12.34")
    function formatUsd(cents) {
        const dollars = Math.abs(cents) / 100;
        return '$' + dollars.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Signed USD formatter (e.g. -1234 -> "-$12.34")
    function formatUsdSigned(cents) {
        const sign = cents < 0 ? '-' : '';
        return sign + formatUsd(cents);
    }

    // Hook into tab switching to populate tenant lists when Billing tabs open
    const originalOpenTab = openTab;
    openTab = function(evt, tabName) {
        originalOpenTab(evt, tabName);
        if (tabName === 'Billing') {
            populateBillingTenants();
        }
    };

    // =====================================================
    // Usage Analytics Functions
    // =====================================================

    let analyticsExpanded = false;
    let analyticsData = null;
    let analyticsSortColumn = 'total_cost';
    let analyticsSortDirection = 'desc';
    let analyticsHourlyViewMode = 'chart';
    let analyticsHourlyTableReady = false;
    let analyticsSelectedGroupKey = null;
    let analyticsGroupDetailRequestId = 0;
    let analyticsGroupDetailRawRows = [];
    let analyticsGroupDetailRows = [];
    let analyticsDetailGranularity = 'hourly';
    let analyticsDetailSortColumn = 'period';
    let analyticsDetailSortDirection = 'desc';

    function toggleUsageAnalytics() {
        analyticsExpanded = !analyticsExpanded;
        document.getElementById('usage-analytics-content').style.display =
            analyticsExpanded ? 'block' : 'none';
        document.getElementById('analytics-toggle-icon').textContent =
            analyticsExpanded ? '▼' : '▶';

        if (analyticsExpanded) {
            const customEl = document.getElementById('analytics-custom-range');
            if (customEl) {
                const range = document.getElementById('analytics-time-range').value;
                customEl.style.display = range === 'custom' ? 'flex' : 'none';
            }
            updateAnalyticsHourlyViewButtons();
            updateAnalyticsHourlyViewControls();
            updateAnalyticsRangeButtons();
            loadAnalytics();
        }
    }

    function onAnalyticsTimeRangeChange() {
        const range = document.getElementById('analytics-time-range').value;
        if (range !== 'custom') {
            const hours = parseInt(range, 10);
            if (!Number.isNaN(hours)) {
                setAnalyticsRangeHours(hours);
                return;
            }
        }
        const customEl = document.getElementById('analytics-custom-range');
        if (customEl) {
            customEl.style.display = range === 'custom' ? 'flex' : 'none';
        }
        if (range === 'custom') {
            setDefaultCustomRangeInputs();
        }
        loadAnalytics();
    }

    function getAnalyticsTimeParams() {
        const range = document.getElementById('analytics-time-range').value;
        if (range === 'custom') {
            if (
                !analyticsUsageRange ||
                analyticsUsageRange.mode !== 'custom' ||
                !analyticsUsageRange.start ||
                !analyticsUsageRange.end
            ) {
                if (!syncAnalyticsCustomRangeFromInputs(false)) return null;
            }
            return `start=${encodeURIComponent(analyticsUsageRange.start)}&end=${encodeURIComponent(analyticsUsageRange.end)}`;
        }
        return `hours=${range}`;
    }

    function getAnalyticsViewMode() {
        return document.querySelector('input[name="analytics-view"]:checked').value;
    }

    function getAnalyticsUsageMs(entry) {
        if (typeof entry?.usage_ms === 'number') return entry.usage_ms;
        const infMs = typeof entry?.inference_ms === 'number' ? entry.inference_ms : 0;
        const sbyMs = typeof entry?.standby_ms === 'number' ? entry.standby_ms : 0;
        return infMs + sbyMs;
    }

    function updateAnalyticsHourlyViewControls() {
        const controlsEl = document.getElementById('analytics-hourly-view-controls');
        if (!controlsEl) return;
        controlsEl.style.display = getAnalyticsViewMode() === 'hourly' ? 'flex' : 'none';
    }

    function updateAnalyticsHourlyViewButtons() {
        const chartBtn = document.getElementById('analytics-hourly-view-chart');
        const tableBtn = document.getElementById('analytics-hourly-view-table');
        if (!chartBtn || !tableBtn) return;
        chartBtn.classList.toggle('active-range', analyticsHourlyViewMode === 'chart');
        tableBtn.classList.toggle('active-range', analyticsHourlyViewMode === 'table');
    }

    function applyAnalyticsHourlyViewVisibility() {
        const chartEl = document.getElementById('analytics-chart-area');
        const hourlyTableEl = document.getElementById('analytics-hourly-table-area');
        if (!chartEl || !hourlyTableEl) return;

        const showTable = analyticsHourlyViewMode === 'table' && analyticsHourlyTableReady;
        chartEl.style.display = showTable ? 'none' : 'block';
        hourlyTableEl.style.display = showTable ? 'block' : 'none';
    }

    function setAnalyticsHourlyViewMode(mode) {
        analyticsHourlyViewMode = mode === 'table' ? 'table' : 'chart';
        updateAnalyticsHourlyViewButtons();
        if (getAnalyticsViewMode() === 'hourly') {
            applyAnalyticsHourlyViewVisibility();
        }
    }

    function getAnalyticsGroupKey(viewMode, item) {
        if (!item) return null;
        if (viewMode === 'model') {
            return `model:${item.namespace || ''}:${item.funcname || ''}`;
        }
        if (viewMode === 'tenant') {
            return `tenant:${item.tenant || ''}`;
        }
        return `namespace:${item.namespace || ''}`;
    }

    function getAnalyticsDetailGranularityLabel(granularity) {
        switch (granularity) {
            case 'daily':
                return 'Daily';
            case 'weekly':
                return 'Weekly';
            case 'hourly':
            default:
                return 'Hourly';
        }
    }

    function updateAnalyticsDetailGranularityButtons() {
        const hourlyBtn = document.getElementById('analytics-detail-granularity-hourly');
        const dailyBtn = document.getElementById('analytics-detail-granularity-daily');
        const weeklyBtn = document.getElementById('analytics-detail-granularity-weekly');
        if (!hourlyBtn || !dailyBtn || !weeklyBtn) return;

        hourlyBtn.classList.toggle('active-range', analyticsDetailGranularity === 'hourly');
        dailyBtn.classList.toggle('active-range', analyticsDetailGranularity === 'daily');
        weeklyBtn.classList.toggle('active-range', analyticsDetailGranularity === 'weekly');
    }

    function getLocalWeekStart(date) {
        const d = new Date(date.getTime());
        d.setHours(0, 0, 0, 0);
        const day = d.getDay();
        const daysSinceMonday = (day + 6) % 7;
        d.setDate(d.getDate() - daysSinceMonday);
        return d;
    }

    function aggregateAnalyticsDetailRows(usageRows, granularity) {
        const rows = Array.isArray(usageRows) ? usageRows : [];
        if (granularity === 'hourly') return rows;

        const bucketMap = new Map();
        rows.forEach(u => {
            const rawDate = new Date(u.hour);
            if (Number.isNaN(rawDate.getTime())) return;

            let bucketStart;
            if (granularity === 'weekly') {
                bucketStart = getLocalWeekStart(rawDate);
            } else {
                bucketStart = new Date(rawDate.getTime());
                bucketStart.setHours(0, 0, 0, 0);
            }

            const key = String(bucketStart.getTime());
            if (!bucketMap.has(key)) {
                const bucketEnd = new Date(bucketStart.getTime());
                if (granularity === 'weekly') {
                    bucketEnd.setDate(bucketEnd.getDate() + 6);
                }
                bucketMap.set(key, {
                    hour: bucketStart.toISOString(),
                    week_end: granularity === 'weekly' ? bucketEnd.toISOString() : null,
                    inference_ms: 0,
                    standby_ms: 0,
                    inference_cents: 0,
                    standby_cents: 0,
                    charge_cents: 0,
                });
            }

            const bucket = bucketMap.get(key);
            bucket.inference_ms += u.inference_ms || 0;
            bucket.standby_ms += u.standby_ms || 0;
            bucket.inference_cents += u.inference_cents || 0;
            bucket.standby_cents += u.standby_cents || 0;
            bucket.charge_cents += u.charge_cents || 0;
        });

        return Array.from(bucketMap.values()).sort((a, b) => a.hour.localeCompare(b.hour));
    }

    function formatAnalyticsDetailPeriodLabel(row) {
        if (analyticsDetailGranularity === 'weekly') {
            const start = new Date(row.hour);
            const end = row.week_end ? new Date(row.week_end) : new Date(start.getTime());
            if (!row.week_end) end.setDate(end.getDate() + 6);
            const startLabel = start.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
            const endLabel = end.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
            return `${startLabel} - ${endLabel}`;
        }
        if (analyticsDetailGranularity === 'daily') {
            return new Date(row.hour).toLocaleDateString(undefined, {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }
        return new Date(row.hour).toLocaleString(undefined, {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
    }

    function setAnalyticsDetailGranularity(granularity) {
        if (granularity !== 'hourly' && granularity !== 'daily' && granularity !== 'weekly') return;
        analyticsDetailGranularity = granularity;
        updateAnalyticsDetailGranularityButtons();
        if (analyticsGroupDetailRawRows.length > 0) {
            analyticsGroupDetailRows = aggregateAnalyticsDetailRows(
                analyticsGroupDetailRawRows,
                analyticsDetailGranularity
            );
            renderAnalyticsGroupDetailTable(analyticsGroupDetailRows);
        }
    }

    function hideAnalyticsGroupDetail(clearSelection = false) {
        const areaEl = document.getElementById('analytics-group-detail-area');
        const loadingEl = document.getElementById('analytics-group-detail-loading');
        const messageEl = document.getElementById('analytics-group-detail-message');
        const tableEl = document.getElementById('analytics-group-detail-table');
        const tbody = document.querySelector('#analytics-group-detail-table tbody');
        if (areaEl) areaEl.style.display = 'none';
        if (loadingEl) loadingEl.style.display = 'none';
        if (messageEl) {
            messageEl.style.display = 'none';
            messageEl.textContent = '';
        }
        if (tableEl) tableEl.style.display = 'table';
        if (tbody) tbody.innerHTML = '';
        if (clearSelection) analyticsSelectedGroupKey = null;
        analyticsGroupDetailRawRows = [];
        analyticsGroupDetailRows = [];
        analyticsGroupDetailRequestId += 1;
    }

    function showAnalyticsGroupDetailPrompt(message) {
        const areaEl = document.getElementById('analytics-group-detail-area');
        const loadingEl = document.getElementById('analytics-group-detail-loading');
        const messageEl = document.getElementById('analytics-group-detail-message');
        const tableEl = document.getElementById('analytics-group-detail-table');
        const tbody = document.querySelector('#analytics-group-detail-table tbody');
        if (!areaEl || !loadingEl || !messageEl || !tableEl || !tbody) return;

        areaEl.style.display = 'block';
        updateAnalyticsDetailGranularityButtons();
        loadingEl.style.display = 'none';
        messageEl.style.display = 'block';
        messageEl.textContent = message;
        tableEl.style.display = 'none';
        tbody.innerHTML = '';
    }

    async function loadAnalyticsGroupDetail(viewMode, item) {
        const tenant = document.getElementById('billing_tenant_select').value;
        if (!tenant || !item) return;

        const timeParams = getAnalyticsTimeParams();
        if (!timeParams) return;

        const areaEl = document.getElementById('analytics-group-detail-area');
        const loadingEl = document.getElementById('analytics-group-detail-loading');
        const messageEl = document.getElementById('analytics-group-detail-message');
        const tableEl = document.getElementById('analytics-group-detail-table');
        const titleEl = document.getElementById('analytics-group-detail-title');
        const tbody = document.querySelector('#analytics-group-detail-table tbody');
        if (!areaEl || !loadingEl || !messageEl || !tableEl || !titleEl || !tbody) return;

        const params = new URLSearchParams(timeParams);
        let endpoint = '';
        if (viewMode === 'tenant') {
            endpoint = `/demo/proxy1/tenant/${tenant}/usage/hourly?${params.toString()}`;
            titleEl.textContent = `Breakdown: ${tenantDisplayLabel(tenant)}`;
        } else if (viewMode === 'model') {
            params.set('namespace', item.namespace || '');
            params.set('funcname', item.funcname || '');
            endpoint = `/demo/proxy1/tenant/${tenant}/usage/hourly-by-model?${params.toString()}`;
            titleEl.textContent = `Breakdown: ${item.funcname || '--'} (${item.namespace || '--'})`;
        } else {
            params.set('namespace', item.namespace || '');
            endpoint = `/demo/proxy1/tenant/${tenant}/usage/hourly-by-namespace?${params.toString()}`;
            titleEl.textContent = `Breakdown: ${item.namespace || '--'}`;
        }

        const reqId = ++analyticsGroupDetailRequestId;
        analyticsGroupDetailRawRows = [];
        analyticsGroupDetailRows = [];
        areaEl.style.display = 'block';
        updateAnalyticsDetailGranularityButtons();
        loadingEl.style.display = 'inline';
        messageEl.style.display = 'none';
        messageEl.textContent = '';
        tbody.innerHTML = '';

        try {
            const resp = await fetchWithAuth(endpoint);
            if (reqId !== analyticsGroupDetailRequestId) return;

            if (resp.status === 404) {
                tableEl.style.display = 'none';
                messageEl.style.display = 'block';
                messageEl.textContent = 'Detail endpoint is not available yet.';
                return;
            }
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

            const data = await resp.json();
            const usageRows = Array.isArray(data.usage) ? data.usage : [];
            if (usageRows.length === 0) {
                tableEl.style.display = 'none';
                messageEl.style.display = 'block';
                messageEl.textContent = 'No detail data for the selected group.';
                return;
            }

            analyticsGroupDetailRawRows = usageRows;
            analyticsGroupDetailRows = aggregateAnalyticsDetailRows(
                analyticsGroupDetailRawRows,
                analyticsDetailGranularity
            );
            updateAnalyticsDetailGranularityButtons();
            renderAnalyticsGroupDetailTable(analyticsGroupDetailRows);

            tableEl.style.display = 'table';
            messageEl.style.display = 'none';
        } catch (error) {
            if (reqId !== analyticsGroupDetailRequestId) return;
            tableEl.style.display = 'none';
            messageEl.style.display = 'block';
            messageEl.textContent = `Failed to load detail: ${error}`;
        } finally {
            if (reqId === analyticsGroupDetailRequestId) {
                loadingEl.style.display = 'none';
            }
        }
    }

    function renderAnalyticsGroupDetailTable(usageRows) {
        const tbody = document.querySelector('#analytics-group-detail-table tbody');
        const granularityEl = document.getElementById('analytics-group-detail-period-granularity');
        if (!tbody) return;
        if (granularityEl) granularityEl.textContent = getAnalyticsDetailGranularityLabel(analyticsDetailGranularity);

        const rows = Array.isArray(usageRows) ? usageRows : [];
        const sortedRows = [...rows].sort((a, b) => {
            let aVal;
            let bVal;
            switch (analyticsDetailSortColumn) {
                case 'inf_hours':
                    aVal = a.inference_ms || 0;
                    bVal = b.inference_ms || 0;
                    break;
                case 'sby_hours':
                    aVal = a.standby_ms || 0;
                    bVal = b.standby_ms || 0;
                    break;
                case 'inf_cost':
                    aVal = a.inference_cents || 0;
                    bVal = b.inference_cents || 0;
                    break;
                case 'sby_cost':
                    aVal = a.standby_cents || 0;
                    bVal = b.standby_cents || 0;
                    break;
                case 'total_cost':
                    aVal = (a.inference_cents || 0) + (a.standby_cents || 0);
                    bVal = (b.inference_cents || 0) + (b.standby_cents || 0);
                    break;
                case 'period':
                default:
                    aVal = Date.parse(a.hour) || 0;
                    bVal = Date.parse(b.hour) || 0;
                    break;
            }
            return analyticsDetailSortDirection === 'asc' ? (aVal - bVal) : (bVal - aVal);
        });

        let totalInfMs = 0;
        let totalSbyMs = 0;
        let totalInfCents = 0;
        let totalSbyCents = 0;

        rows.forEach(u => {
            totalInfMs += u.inference_ms || 0;
            totalSbyMs += u.standby_ms || 0;
            totalInfCents += u.inference_cents || 0;
            totalSbyCents += u.standby_cents || 0;
        });

        tbody.innerHTML = sortedRows.map(u => {
            const infMs = u.inference_ms || 0;
            const sbyMs = u.standby_ms || 0;
            const infCents = u.inference_cents || 0;
            const sbyCents = u.standby_cents || 0;
            const infHours = infMs / 3600000;
            const sbyHours = sbyMs / 3600000;
            const totalCents = infCents + sbyCents;
            const periodLabel = formatAnalyticsDetailPeriodLabel(u);

            return `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 8px; text-align: left;">${periodLabel}</td>
                    <td style="padding: 8px; text-align: right;">${infHours.toFixed(2)}</td>
                    <td style="padding: 8px; text-align: right;">${sbyHours.toFixed(2)}</td>
                    <td style="padding: 8px; text-align: right;">${formatUsd(infCents)}</td>
                    <td style="padding: 8px; text-align: right;">${formatUsd(sbyCents)}</td>
                    <td style="padding: 8px; text-align: right;">${formatUsd(totalCents)}</td>
                </tr>
            `;
        }).join('');

        document.getElementById('analytics-group-total-inf-hours').textContent = (totalInfMs / 3600000).toFixed(2);
        document.getElementById('analytics-group-total-sby-hours').textContent = (totalSbyMs / 3600000).toFixed(2);
        document.getElementById('analytics-group-total-inf-cost').textContent = formatUsd(totalInfCents);
        document.getElementById('analytics-group-total-sby-cost').textContent = formatUsd(totalSbyCents);
        document.getElementById('analytics-group-total-cost').textContent = formatUsd(totalInfCents + totalSbyCents);

        const setDetailSortIcon = (id, column) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = analyticsDetailSortColumn === column
                ? (analyticsDetailSortDirection === 'asc' ? '▲' : '▼')
                : '';
        };
        setDetailSortIcon('detail-sort-period-icon', 'period');
        setDetailSortIcon('detail-sort-inf-hours-icon', 'inf_hours');
        setDetailSortIcon('detail-sort-sby-hours-icon', 'sby_hours');
        setDetailSortIcon('detail-sort-inf-cost-icon', 'inf_cost');
        setDetailSortIcon('detail-sort-sby-cost-icon', 'sby_cost');
        setDetailSortIcon('detail-sort-total-cost-icon', 'total_cost');
    }

    function sortAnalyticsGroupDetailTable(column) {
        if (analyticsDetailSortColumn === column) {
            analyticsDetailSortDirection = analyticsDetailSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            analyticsDetailSortColumn = column;
            analyticsDetailSortDirection = 'desc';
        }

        if (analyticsGroupDetailRows.length > 0) {
            renderAnalyticsGroupDetailTable(analyticsGroupDetailRows);
        }
    }

    function showAnalyticsLoading(show) {
        document.getElementById('analytics-loading').style.display = show ? 'inline' : 'none';
    }

    function showAnalyticsError(message) {
        hideAnalyticsGroupDetail(true);
        document.getElementById('analytics-chart-area').style.display = 'none';
        document.getElementById('analytics-hourly-table-area').style.display = 'none';
        document.getElementById('analytics-table-area').style.display = 'none';
        document.getElementById('analytics-empty').style.display = 'none';
        const controlsEl = document.getElementById('analytics-hourly-view-controls');
        if (controlsEl) controlsEl.style.display = 'none';
        analyticsHourlyTableReady = false;

        const el = document.getElementById('analytics-error');
        document.getElementById('analytics-error-message').textContent = message || 'Unknown error';
        el.style.display = 'block';
    }

    function showAnalyticsEmpty() {
        hideAnalyticsGroupDetail(true);
        document.getElementById('analytics-chart-area').style.display = 'none';
        document.getElementById('analytics-hourly-table-area').style.display = 'none';
        document.getElementById('analytics-table-area').style.display = 'none';
        document.getElementById('analytics-error').style.display = 'none';
        const controlsEl = document.getElementById('analytics-hourly-view-controls');
        if (controlsEl) controlsEl.style.display = 'none';
        analyticsHourlyTableReady = false;
        document.getElementById('analytics-empty').style.display = 'block';
    }

    async function loadAnalytics() {
        const tenant = document.getElementById('billing_tenant_select').value;
        if (!tenant) return;

        const timeParams = getAnalyticsTimeParams();
        if (!timeParams) return;

        showAnalyticsLoading(true);
        document.getElementById('analytics-error').style.display = 'none';
        document.getElementById('analytics-empty').style.display = 'none';

        try {
            // Load current view
            await loadAnalyticsView();
        } catch (error) {
            console.error('Failed to load analytics:', error);
            showAnalyticsError(error.message);
        } finally {
            showAnalyticsLoading(false);
        }
    }

    async function loadAnalyticsView() {
        const tenant = document.getElementById('billing_tenant_select').value;
        if (!tenant) return;

        const timeParams = getAnalyticsTimeParams();
        if (!timeParams) return;

        const viewMode = getAnalyticsViewMode();
        updateAnalyticsHourlyViewButtons();
        updateAnalyticsHourlyViewControls();
        hideAnalyticsGroupDetail(true);
        analyticsHourlyTableReady = false;
        document.getElementById('analytics-hourly-table-area').style.display = 'none';
        document.getElementById('analytics-chart-area').style.display = 'none';
        let endpoint;

        switch (viewMode) {
            case 'tenant':
                endpoint = `/demo/proxy1/tenant/${tenant}/usage/hourly?${timeParams}`;
                break;
            case 'model':
                endpoint = `/demo/proxy1/tenant/${tenant}/usage/by-model?${timeParams}`;
                break;
            case 'namespace':
                endpoint = `/demo/proxy1/tenant/${tenant}/usage/by-namespace?${timeParams}`;
                break;
            default:
                endpoint = `/demo/proxy1/tenant/${tenant}/usage/hourly?${timeParams}`;
                break;
        }

        showAnalyticsLoading(true);

        try {
            const resp = await fetchWithAuth(endpoint);

            if (resp.status === 404) {
                showAnalyticsError('This endpoint is not yet implemented');
                return;
            }

            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();

            if (viewMode === 'tenant') {
                renderTenantGroupedTable(data, tenant);
            } else {
                analyticsData = data;
                renderGroupedTable(data, viewMode);
            }
        } catch (error) {
            console.error('Failed to load analytics view:', error);
            showAnalyticsError(error.message);
        } finally {
            showAnalyticsLoading(false);
        }
    }

    function renderTenantGroupedTable(hourlyData, tenantName) {
        const usageRows = Array.isArray(hourlyData?.usage) ? hourlyData.usage : [];
        if (usageRows.length === 0) {
            showAnalyticsEmpty();
            return;
        }

        let totalInfMs = 0;
        let totalSbyMs = 0;
        let totalInfCents = 0;
        let totalSbyCents = 0;

        usageRows.forEach(u => {
            totalInfMs += u.inference_ms || 0;
            totalSbyMs += u.standby_ms || 0;
            totalInfCents += u.inference_cents || 0;
            totalSbyCents += u.standby_cents || 0;
        });

        const grouped = {
            usage: [{
                tenant: tenantName,
                inference_ms: totalInfMs,
                standby_ms: totalSbyMs,
                usage_ms: totalInfMs + totalSbyMs,
                inference_cents: totalInfCents,
                standby_cents: totalSbyCents,
                charge_cents: totalInfCents + totalSbyCents
            }],
            other: {
                count: 0,
                inference_ms: 0,
                standby_ms: 0,
                usage_ms: 0,
                inference_cents: 0,
                standby_cents: 0,
                charge_cents: 0
            },
            inference_ms: totalInfMs,
            standby_ms: totalSbyMs,
            total_ms: totalInfMs + totalSbyMs,
            inference_cents: totalInfCents,
            standby_cents: totalSbyCents,
            total_cents: totalInfCents + totalSbyCents
        };

        analyticsData = grouped;
        renderGroupedTable(grouped, 'tenant');
    }

    function renderGroupedTable(data, viewMode) {
        document.getElementById('analytics-error').style.display = 'none';
        const hourlyControlsEl = document.getElementById('analytics-hourly-view-controls');
        if (hourlyControlsEl) hourlyControlsEl.style.display = 'none';
        document.getElementById('analytics-hourly-table-area').style.display = 'none';
        analyticsHourlyTableReady = false;

        if (!data.usage || data.usage.length === 0) {
            showAnalyticsEmpty();
            return;
        }

        const tbody = document.querySelector('#analytics-table tbody');
        tbody.innerHTML = '';

        // Update header based on view mode
        const headerEl = document.getElementById('analytics-group-header');
        const groupHeader = viewMode === 'model'
            ? 'Model'
            : (viewMode === 'namespace' ? 'Namespace' : 'Tenant');
        headerEl.innerHTML = groupHeader +
            ' <span id="sort-name-icon">' + (analyticsSortColumn === 'name' ? (analyticsSortDirection === 'asc' ? '▲' : '▼') : '') + '</span>';

        const totalInfMs = (typeof data.inference_ms === 'number')
            ? data.inference_ms
            : (
                data.usage.reduce((sum, u) => sum + (u.inference_ms || 0), 0) +
                (data.other?.inference_ms || 0)
            );
        const totalSbyMs = (typeof data.standby_ms === 'number')
            ? data.standby_ms
            : (
                data.usage.reduce((sum, u) => sum + (u.standby_ms || 0), 0) +
                (data.other?.standby_ms || 0)
            );
        const totalInfCents = (typeof data.inference_cents === 'number')
            ? data.inference_cents
            : (
                data.usage.reduce((sum, u) => sum + (u.inference_cents || 0), 0) +
                (data.other?.inference_cents || 0)
            );
        const totalSbyCents = (typeof data.standby_cents === 'number')
            ? data.standby_cents
            : (
                data.usage.reduce((sum, u) => sum + (u.standby_cents || 0), 0) +
                (data.other?.standby_cents || 0)
            );
        const totalCents = (typeof data.total_cents === 'number') ? data.total_cents : (totalInfCents + totalSbyCents);

        // Sort data
        let sortedData = [...data.usage];
        sortedData.sort((a, b) => {
            let aVal;
            let bVal;
            const aInfMs = a.inference_ms || 0;
            const aSbyMs = a.standby_ms || 0;
            const aInfCents = a.inference_cents || 0;
            const aSbyCents = a.standby_cents || 0;
            const aTotalCents = (typeof a.charge_cents === 'number') ? a.charge_cents : (aInfCents + aSbyCents);
            const bInfMs = b.inference_ms || 0;
            const bSbyMs = b.standby_ms || 0;
            const bInfCents = b.inference_cents || 0;
            const bSbyCents = b.standby_cents || 0;
            const bTotalCents = (typeof b.charge_cents === 'number') ? b.charge_cents : (bInfCents + bSbyCents);

            if (analyticsSortColumn === 'name') {
                aVal = viewMode === 'model'
                    ? a.funcname
                    : (viewMode === 'namespace' ? a.namespace : tenantDisplayLabel(a.tenant));
                bVal = viewMode === 'model'
                    ? b.funcname
                    : (viewMode === 'namespace' ? b.namespace : tenantDisplayLabel(b.tenant));
                return analyticsSortDirection === 'asc'
                    ? aVal.localeCompare(bVal)
                    : bVal.localeCompare(aVal);
            }

            switch (analyticsSortColumn) {
                case 'inf_hours':
                    aVal = aInfMs;
                    bVal = bInfMs;
                    break;
                case 'sby_hours':
                    aVal = aSbyMs;
                    bVal = bSbyMs;
                    break;
                case 'inf_cost':
                    aVal = aInfCents;
                    bVal = bInfCents;
                    break;
                case 'sby_cost':
                    aVal = aSbyCents;
                    bVal = bSbyCents;
                    break;
                case 'percent':
                    aVal = totalCents > 0 ? (aTotalCents / totalCents) : 0;
                    bVal = totalCents > 0 ? (bTotalCents / totalCents) : 0;
                    break;
                case 'total_cost':
                default:
                    aVal = aTotalCents;
                    bVal = bTotalCents;
                    break;
            }
            return analyticsSortDirection === 'asc' ? (aVal - bVal) : (bVal - aVal);
        });

        let selectedItem = null;
        sortedData.forEach(item => {
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid #eee';
            row.style.cursor = 'pointer';
            const groupLabel = viewMode === 'model'
                ? `${item.funcname} (${item.namespace})`
                : (viewMode === 'namespace' ? item.namespace : tenantDisplayLabel(item.tenant));
            const infMs = item.inference_ms || 0;
            const sbyMs = item.standby_ms || 0;
            const infCents = item.inference_cents || 0;
            const sbyCents = item.standby_cents || 0;
            const chargeCents = (typeof item.charge_cents === 'number') ? item.charge_cents : (infCents + sbyCents);
            const infHours = (infMs / 3600000).toFixed(2);
            const sbyHours = (sbyMs / 3600000).toFixed(2);
            const percent = totalCents > 0 ? ((chargeCents / totalCents) * 100).toFixed(1) : 0;

            const barWidth = Math.min(percent, 100);
            const bar = `<div style="background: #4CAF50; width: ${barWidth}%; height: 12px; display: inline-block; margin-right: 5px;"></div>`;
            const rowKey = getAnalyticsGroupKey(viewMode, item);
            if (rowKey === analyticsSelectedGroupKey) {
                row.style.background = '#f0f7ff';
                selectedItem = item;
            }
            row.onclick = () => {
                analyticsSelectedGroupKey = rowKey;
                renderGroupedTable(data, viewMode);
            };

            row.innerHTML = `
                <td style="padding: 8px;" title="${groupLabel}">${truncateText(groupLabel, 40)}</td>
                <td style="text-align: right; padding: 8px;">${infHours}</td>
                <td style="text-align: right; padding: 8px;">${sbyHours}</td>
                <td style="text-align: right; padding: 8px;">${formatUsd(infCents)}</td>
                <td style="text-align: right; padding: 8px;">${formatUsd(sbyCents)}</td>
                <td style="text-align: right; padding: 8px;">${formatUsd(chargeCents)}</td>
                <td style="text-align: right; padding: 8px;">${bar}${percent}%</td>
            `;
            tbody.appendChild(row);
        });

        // Add "Other" row if present
        if ((viewMode === 'model' || viewMode === 'namespace') && data.other && data.other.count > 0) {
            const row = document.createElement('tr');
            row.style.color = '#888';
            row.style.fontStyle = 'italic';
            row.style.borderBottom = '1px solid #eee';
            const otherInfMs = data.other.inference_ms || 0;
            const otherSbyMs = data.other.standby_ms || 0;
            const otherInfCents = data.other.inference_cents || 0;
            const otherSbyCents = data.other.standby_cents || 0;
            const otherCents = (typeof data.other.charge_cents === 'number')
                ? data.other.charge_cents
                : (otherInfCents + otherSbyCents);
            const percent = totalCents > 0 ? ((otherCents / totalCents) * 100).toFixed(1) : 0;
            const barWidth = Math.min(percent, 100);
            const bar = `<div style="background: #ccc; width: ${barWidth}%; height: 12px; display: inline-block; margin-right: 5px;"></div>`;

            row.innerHTML = `
                <td style="padding: 8px;">Other (${data.other.count} ${viewMode === 'model' ? 'models' : 'namespaces'})</td>
                <td style="text-align: right; padding: 8px;">${(otherInfMs / 3600000).toFixed(2)}</td>
                <td style="text-align: right; padding: 8px;">${(otherSbyMs / 3600000).toFixed(2)}</td>
                <td style="text-align: right; padding: 8px;">${formatUsd(otherInfCents)}</td>
                <td style="text-align: right; padding: 8px;">${formatUsd(otherSbyCents)}</td>
                <td style="text-align: right; padding: 8px;">${formatUsd(otherCents)}</td>
                <td style="text-align: right; padding: 8px;">${bar}${percent}%</td>
            `;
            tbody.appendChild(row);
        }

        // Update totals
        document.getElementById('analytics-table-total-inf-hours').textContent = (totalInfMs / 3600000).toFixed(2);
        document.getElementById('analytics-table-total-sby-hours').textContent = (totalSbyMs / 3600000).toFixed(2);
        document.getElementById('analytics-table-total-inf-cost').textContent = formatUsd(totalInfCents);
        document.getElementById('analytics-table-total-sby-cost').textContent = formatUsd(totalSbyCents);
        document.getElementById('analytics-table-total-cost').textContent = formatUsd(totalCents);

        // Update sort icons
        const setSummarySortIcon = (id, column) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = analyticsSortColumn === column
                ? (analyticsSortDirection === 'asc' ? '▲' : '▼')
                : '';
        };
        setSummarySortIcon('sort-name-icon', 'name');
        setSummarySortIcon('sort-inf-hours-icon', 'inf_hours');
        setSummarySortIcon('sort-sby-hours-icon', 'sby_hours');
        setSummarySortIcon('sort-inf-cost-icon', 'inf_cost');
        setSummarySortIcon('sort-sby-cost-icon', 'sby_cost');
        setSummarySortIcon('sort-total-cost-icon', 'total_cost');
        setSummarySortIcon('sort-percent-icon', 'percent');

        // Show table, hide chart and empty state
        document.getElementById('analytics-table-area').style.display = 'block';
        document.getElementById('analytics-chart-area').style.display = 'none';
        document.getElementById('analytics-empty').style.display = 'none';

        if (selectedItem) {
            loadAnalyticsGroupDetail(viewMode, selectedItem);
        } else {
            showAnalyticsGroupDetailPrompt(
                viewMode === 'model'
                    ? 'Select a model row above to view hourly drill-down.'
                    : (viewMode === 'namespace'
                        ? 'Select a namespace row above to view hourly drill-down.'
                        : 'Select the tenant row above to view hourly drill-down.')
            );
        }
    }

    function sortAnalyticsTable(column) {
        if (analyticsSortColumn === column) {
            analyticsSortDirection = analyticsSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            analyticsSortColumn = column;
            analyticsSortDirection = column === 'name' ? 'asc' : 'desc';
        }

        if (analyticsData) {
            const viewMode = getAnalyticsViewMode();
            renderGroupedTable(analyticsData, viewMode);
        }
    }

    function renderAnalyticsHourlyChart(data) {
        document.getElementById('analytics-error').style.display = 'none';
        hideAnalyticsGroupDetail(true);
        const chartEl = document.getElementById('analytics-chart-area');

        if (!data.usage || data.usage.length === 0) {
            showAnalyticsEmpty();
            return;
        }

        // For longer time ranges, aggregate to daily
        const hours = data.usage.length;
        const aggregateToDaily = hours > 48;

        let displayData = data.usage;
        if (aggregateToDaily) {
            displayData = aggregateHourlyUsageToDays(data.usage);
        }

        const maxUsageMs = Math.max(...displayData.map(u => getAnalyticsUsageMs(u)), 1);

        chartEl.innerHTML = `
            <div style="display: flex; align-items: flex-end; height: 120px; gap: 2px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">
                ${displayData.map(u => {
                    const usageMs = getAnalyticsUsageMs(u);
                    const height = Math.max(2, (usageMs / maxUsageMs) * 100);
                    const usageHours = (usageMs / 3600000).toFixed(2);
                    const label = aggregateToDaily
                        ? new Date(u.hour).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})
                        : new Date(u.hour).getHours().toString().padStart(2, '0') + ':00';
                    return `<div class="usage-bar" style="height: ${height}%; flex: 1;"
                                title="${label}: ${usageHours} GPU-hours"></div>`;
                }).join('')}
            </div>
            <div style="display: flex; gap: 2px; font-size: 10px; color: #666;">
                ${displayData.map((u, i) => {
                    const showLabel = aggregateToDaily
                        ? (i % 5 === 0)
                        : (i % 6 === 0);
                    const label = showLabel
                        ? (aggregateToDaily
                            ? new Date(u.hour).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})
                            : new Date(u.hour).getHours().toString().padStart(2, '0'))
                        : '';
                    return `<div style="flex: 1; text-align: center;">${label}</div>`;
                }).join('')}
            </div>
            <div style="text-align: right; font-size: 10px; color: #888;">
                (${aggregateToDaily ? 'Daily' : 'Hourly'} - Local)
            </div>
        `;

        renderAnalyticsHourlyTable(displayData, aggregateToDaily);
        analyticsHourlyTableReady = true;
        updateAnalyticsHourlyViewButtons();
        updateAnalyticsHourlyViewControls();
        document.getElementById('analytics-table-area').style.display = 'none';
        applyAnalyticsHourlyViewVisibility();
        document.getElementById('analytics-empty').style.display = 'none';
    }

    function renderAnalyticsHourlyTable(displayData, aggregateToDaily) {
        const tableBodyEl = document.querySelector('#analytics-hourly-table tbody');
        const totalEl = document.getElementById('analytics-hourly-table-total');
        const granularityEl = document.getElementById('analytics-hourly-table-granularity');
        if (!tableBodyEl || !totalEl || !granularityEl) return;

        granularityEl.textContent = aggregateToDaily ? 'Daily' : 'Hourly';

        const sortedRows = [...displayData].sort((a, b) => b.hour.localeCompare(a.hour));
        let totalMs = 0;

        tableBodyEl.innerHTML = sortedRows.map(u => {
            const usageMs = getAnalyticsUsageMs(u);
            totalMs += usageMs;
            const usageHours = usageMs / 3600000;
            const periodLabel = aggregateToDaily
                ? new Date(u.hour).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' })
                : new Date(u.hour).toLocaleString(undefined, {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });

            return `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="text-align: left; padding: 8px;">${periodLabel}</td>
                    <td style="text-align: right; padding: 8px;">${usageHours.toFixed(2)}</td>
                </tr>
            `;
        }).join('');

        totalEl.textContent = (totalMs / 3600000).toFixed(2);
    }

    function aggregateHourlyUsageByGranularity(hourlyData, granularity) {
        const rows = Array.isArray(hourlyData) ? hourlyData : [];
        if (granularity === 'hourly') {
            return [...rows].sort((a, b) => (a.hour || '').localeCompare(b.hour || ''));
        }

        const bucketMap = new Map();
        rows.forEach(h => {
            const rawDate = new Date(h.hour);
            if (Number.isNaN(rawDate.getTime())) return;

            let bucketStart;
            let bucketEnd = null;
            if (granularity === 'weekly') {
                bucketStart = getLocalWeekStart(rawDate);
                bucketEnd = new Date(bucketStart.getTime());
                bucketEnd.setDate(bucketEnd.getDate() + 6);
            } else {
                bucketStart = new Date(rawDate.getTime());
                bucketStart.setHours(0, 0, 0, 0);
            }

            const key = String(bucketStart.getTime());
            if (!bucketMap.has(key)) {
                bucketMap.set(key, {
                    hour: bucketStart.toISOString(),
                    week_end: bucketEnd ? bucketEnd.toISOString() : null,
                    charge_cents: 0,
                    inference_cents: 0,
                    standby_cents: 0,
                    usage_ms: 0,
                    inference_ms: 0,
                    standby_ms: 0
                });
            }

            const usageMs = (typeof h.usage_ms === 'number')
                ? h.usage_ms
                : ((h.inference_ms || 0) + (h.standby_ms || 0));
            const bucket = bucketMap.get(key);
            bucket.charge_cents += h.charge_cents || 0;
            bucket.inference_cents += h.inference_cents || 0;
            bucket.standby_cents += h.standby_cents || 0;
            bucket.usage_ms += usageMs;
            bucket.inference_ms += h.inference_ms || 0;
            bucket.standby_ms += h.standby_ms || 0;
        });

        return Array.from(bucketMap.values()).sort((a, b) => a.hour.localeCompare(b.hour));
    }

    function aggregateHourlyUsageToDays(hourlyData) {
        return aggregateHourlyUsageByGranularity(hourlyData, 'daily');
    }

    function truncateText(text, maxLength) {
        if (!text) return '--';
        return text.length > maxLength ? text.substring(0, maxLength - 3) + '...' : text;
    }
</script>


<!-- <textarea id="output" rows="20" cols="120"></textarea> -->
<script>
    function IsAdmin(data, targetTenant, targetNamespace = "") {
        if (!data) return false;

        return data.some(rb => {
            // Normalize strings to lowercase and trim any accidental spaces
            const rbObjType = String(rb.objType).toLowerCase().trim();
            const rbRole = String(rb.role).toLowerCase().trim();
            const rbTenant = String(rb.tenant).toLowerCase().trim();
            const rbNamespace = String(rb.namespace).toLowerCase().trim();

            const searchTenant = String(targetTenant).toLowerCase().trim();
            const searchNamespace = String(targetNamespace).toLowerCase().trim();

            const isSystemAdmin = rbObjType === "tenant" &&
                rbTenant === "system" &&
                rbRole === "admin";

            const isTenantAdmin = rbObjType === "tenant" &&
                rbTenant === searchTenant &&
                rbRole === "admin";

            const isNamespaceAdmin = rbObjType === "namespace" &&
                rbTenant === searchTenant &&
                rbNamespace === searchNamespace &&
                rbRole === "admin";

            return isSystemAdmin || isTenantAdmin || isNamespaceAdmin;
        });
    }

    function IsUser(data, targetTenant, targetNamespace = "") {
        // Ensure data exists
        if (!data || !Array.isArray(data)) return false;

        // Normalize target values once
        const searchTenant = String(targetTenant).toLowerCase().trim();
        const searchNamespace = String(targetNamespace).toLowerCase().trim();

        return data.some(rb => {
            // 1. Normalize row values
            const rbObjType = String(rb.objType).toLowerCase().trim();
            const rbRole = String(rb.role).toLowerCase().trim();
            const rbTenant = String(rb.tenant).toLowerCase().trim();
            const rbNamespace = String(rb.namespace || "").toLowerCase().trim();

            // 2. Define Matches
            const isCorrectTenant = rbTenant === searchTenant;
            const isCorrectNamespace = rbNamespace === searchNamespace;

            // 3. Logic: Match if Admin (of this tenant/namespace) OR User (of this tenant/namespace)
            const hasRequiredRole = (rbRole === "user");

            if (rbObjType === "tenant") {
                // Tenant-level roles inherit to everything inside that tenant
                return isCorrectTenant && hasRequiredRole;
            }

            if (rbObjType === "namespace") {
                // Namespace-level roles only apply to that specific namespace
                return isCorrectTenant && isCorrectNamespace && hasRequiredRole;
            }

            return false;
        });
    }

    function setSelectDefaultOption(selectEl, label = '(optional)') {
        if (!selectEl) return;
        selectEl.innerHTML = '';
        const option = document.createElement('option');
        option.value = '';
        option.textContent = label;
        selectEl.appendChild(option);
    }

    function ensureSelectOption(selectEl, value, label) {
        if (!selectEl) return;
        const existing = Array.from(selectEl.options).find(option => option.value === value);
        if (existing) return;
        const option = document.createElement('option');
        option.value = value;
        option.textContent = label;
        selectEl.appendChild(option);
    }

    function setReadonlyFieldMode(selectFieldEl, readonlyFieldEl, readonlyValueEl, showReadonly, text = '') {
        if (selectFieldEl) selectFieldEl.style.display = showReadonly ? 'none' : '';
        if (readonlyFieldEl) readonlyFieldEl.style.display = showReadonly ? '' : 'none';
        if (readonlyValueEl) readonlyValueEl.textContent = showReadonly ? text : '';
    }

    function getNonEmptySelectValues(selectEl) {
        if (!selectEl) return [];
        return Array.from(selectEl.options)
            .map(option => String(option.value || '').trim())
            .filter(value => value !== '');
    }

    function refreshApikeyCreateTenantFieldPresentation() {
        const cardEl = document.getElementById('apikey-create-card');
        const tenantSelect = document.getElementById('apikey_restrict_tenant');
        const tenantSelectField = document.getElementById('apikey-tenant-select-field');
        const tenantReadonlyField = document.getElementById('apikey-tenant-readonly-field');
        const tenantReadonlyValue = document.getElementById('apikey-tenant-readonly-value');
        if (!cardEl || !tenantSelect) return;

        const tenantValues = getNonEmptySelectValues(tenantSelect);
        if (apikeyCreatorIsInferxAdmin) {
            cardEl.style.display = '';
            tenantSelect.value = 'system';
            setReadonlyFieldMode(
                tenantSelectField,
                tenantReadonlyField,
                tenantReadonlyValue,
                true,
                tenantDisplayLabel('system')
            );
            return;
        }

        if (tenantValues.length === 0) {
            cardEl.style.display = 'none';
            setReadonlyFieldMode(tenantSelectField, tenantReadonlyField, tenantReadonlyValue, false);
            return;
        }

        cardEl.style.display = '';
        if (tenantValues.length === 1) {
            tenantSelect.value = tenantValues[0];
            setReadonlyFieldMode(
                tenantSelectField,
                tenantReadonlyField,
                tenantReadonlyValue,
                true,
                tenantDisplayLabel(tenantValues[0])
            );
            return;
        }

        setReadonlyFieldMode(tenantSelectField, tenantReadonlyField, tenantReadonlyValue, false);
        if (!tenantSelect.value || !tenantValues.includes(tenantSelect.value)) {
            tenantSelect.selectedIndex = 0;
        }
    }

    function refreshApikeyCreateNamespaceFieldPresentation() {
        const tenantSelect = document.getElementById('apikey_restrict_tenant');
        const namespaceSelect = document.getElementById('apikey_restrict_namespace');
        const namespaceSelectField = document.getElementById('apikey-namespace-select-field');
        const namespaceReadonlyField = document.getElementById('apikey-namespace-readonly-field');
        const namespaceReadonlyValue = document.getElementById('apikey-namespace-readonly-value');
        if (!namespaceSelect) return;

        if (apikeyCreatorIsInferxAdmin) {
            setReadonlyFieldMode(
                namespaceSelectField,
                namespaceReadonlyField,
                namespaceReadonlyValue,
                true,
                '(not used)'
            );
            return;
        }

        if (!tenantSelect || !tenantSelect.value) {
            setReadonlyFieldMode(namespaceSelectField, namespaceReadonlyField, namespaceReadonlyValue, false);
            return;
        }

        const namespaceValues = getNonEmptySelectValues(namespaceSelect);
        if (namespaceValues.length === 0) {
            setReadonlyFieldMode(
                namespaceSelectField,
                namespaceReadonlyField,
                namespaceReadonlyValue,
                true,
                '(optional)'
            );
            return;
        }

        setReadonlyFieldMode(namespaceSelectField, namespaceReadonlyField, namespaceReadonlyValue, false);
    }

    function configureApikeyCreateForm(roles) {
        const hintEl = document.getElementById('apikey-create-hint');
        const accessLevelSelect = document.getElementById('apikey_access_level');
        const tenantSelect = document.getElementById('apikey_restrict_tenant');
        const namespaceSelect = document.getElementById('apikey_restrict_namespace');
        if (!accessLevelSelect || !tenantSelect || !namespaceSelect) return;

        apikeyCreatorIsInferxAdmin = IsAdmin(roles, "system", "");
        if (apikeyCreatorIsInferxAdmin) {
            ensureSelectOption(tenantSelect, 'system', 'system');
            tenantSelect.value = 'system';
            accessLevelSelect.value = 'full';
            setSelectDefaultOption(namespaceSelect, '(not used)');
            accessLevelSelect.disabled = true;
            tenantSelect.disabled = true;
            namespaceSelect.disabled = true;
            if (hintEl) {
                hintEl.textContent = 'Inferx admin self-created keys are forced to full access level on tenant system.';
            }
            refreshApikeyCreateTenantFieldPresentation();
            refreshApikeyCreateNamespaceFieldPresentation();
            return;
        }

        accessLevelSelect.disabled = false;
        tenantSelect.disabled = false;
        if (hintEl) {
            hintEl.textContent = 'Select a tenant (required), then optionally narrow to a namespace and expiration.';
        }
        refreshApikeyCreateTenantFieldPresentation();
        onApikeyRestrictTenantChange();
    }

    function onApikeyRestrictTenantChange() {
        const tenantSelect = document.getElementById('apikey_restrict_tenant');
        const namespaceSelect = document.getElementById('apikey_restrict_namespace');
        if (!tenantSelect || !namespaceSelect) return;

        const selectedTenant = tenantSelect.value;
        const previousNamespace = namespaceSelect.value;
        setSelectDefaultOption(namespaceSelect);

        if (!selectedTenant) {
            namespaceSelect.disabled = true;
            refreshApikeyCreateNamespaceFieldPresentation();
            return;
        }

        const namespaceList = apikeyRestrictNamespacesByTenant[selectedTenant] || [];
        namespaceList.forEach(ns => {
            const option = document.createElement('option');
            option.value = ns;
            option.textContent = ns;
            namespaceSelect.appendChild(option);
        });

        if (previousNamespace && namespaceList.includes(previousNamespace)) {
            namespaceSelect.value = previousNamespace;
        }

        // Keep enabled for tenant-only restrictions even when no namespace options exist.
        namespaceSelect.disabled = false;
        refreshApikeyCreateNamespaceFieldPresentation();
    }

    function updateDeleteApikeyButtonState() {
        const deleteButton = document.getElementById('delete-button');
        if (!deleteButton) return;

        const hasSelection = document.querySelector('#items-table tbody input[type="checkbox"]:checked') !== null;
        deleteButton.disabled = !hasSelection;
    }

    function formatLocalDateTime(value) {
        if (!value) return '';
        let normalized = String(value).trim();
        if (!normalized) return '';

        // Backend may return naive timestamps (no timezone). Treat them as UTC, then display local.
        const hasTimezone = /(?:Z|[+\-]\d{2}:\d{2})$/.test(normalized);
        if (!hasTimezone) {
            normalized = normalized.replace(' ', 'T');
            if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?$/.test(normalized)) {
                normalized += 'Z';
            }
        }

        const dt = new Date(normalized);
        if (Number.isNaN(dt.getTime())) {
            return String(value);
        }

        return dt.toLocaleString();
    }

    function maskApikey(rawKey) {
        if (!rawKey) return '';
        const s = String(rawKey);
        if (s.length <= 8) return '********';
        return `${s.slice(0, 3)}${'*'.repeat(Math.max(0, s.length - 7))}${s.slice(-4)}`;
    }

    async function copyTextToClipboard(text) {
        if (!text) return false;
        try {
            await navigator.clipboard.writeText(text);
            return true;
        } catch (err) {
            try {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                const copied = document.execCommand('copy');
                document.body.removeChild(textarea);
                return copied;
            } catch (_fallbackErr) {
                return false;
            }
        }
    }

    async function copyApikeyFromRow(button) {
        const cell = button.closest('td');
        if (!cell) return;
        const valueEl = cell.querySelector('.apikey-raw-value');
        if (!valueEl) return;
        const rawKey = valueEl.getAttribute('data-apikey') || '';
        const copied = await copyTextToClipboard(rawKey);
        if (!copied) {
            const existingTimer = Number(button.dataset.resetTimer || 0);
            if (existingTimer) {
                window.clearTimeout(existingTimer);
            }
            button.classList.remove('copied');
            button.setAttribute('data-tooltip', 'Copy failed');
            button.setAttribute('aria-label', 'Copy failed');
            const timerId = window.setTimeout(() => {
                button.setAttribute('data-tooltip', 'Copy key');
                button.setAttribute('aria-label', 'Copy key');
                delete button.dataset.resetTimer;
            }, 1400);
            button.dataset.resetTimer = String(timerId);
            return;
        }

        const existingTimer = Number(button.dataset.resetTimer || 0);
        if (existingTimer) {
            window.clearTimeout(existingTimer);
        }

        button.classList.add('copied');
        button.setAttribute('data-tooltip', 'Copied');
        button.setAttribute('aria-label', 'Copied');
        const timerId = window.setTimeout(() => {
            button.classList.remove('copied');
            button.setAttribute('data-tooltip', 'Copy key');
            button.setAttribute('aria-label', 'Copy key');
            delete button.dataset.resetTimer;
        }, 1400);
        button.dataset.resetTimer = String(timerId);
    }

    async function getTenantUsers(role, tenant) {
        // 1. Build the URL with parameters
        const params = new URLSearchParams({
            role: role,
            tenant: tenant
        });

        const url = `/demo/generate_tenantuser?${params.toString()}`;
        try {
            const response = await fetchWithAuth(url);

            // 2. Check if the request was successful
            if (!response.ok) {
                // If status is 401 or 403, the user might be logged out
                if (response.status === 401 || response.status === 403) {
                    console.error("Session expired or unauthorized. Redirecting to login...");
                    window.location.href = "/login";
                    return [];
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // 3. Parse and return the JSON data
            const users = await response.json();
            return users;

        } catch (error) {
            console.error("Could not fetch tenant users:", error);
            return []; // Return empty array to prevent code from crashing later
        }
    }

    async function getNamespaceUsers(role, tenant, namespace) {
        // 1. Construct the query parameters safely
        const params = new URLSearchParams({
            role: role,
            tenant: tenant,
            namespace: namespace
        });

        const url = `/demo/generate_namespaceuser?${params.toString()}`;

        try {
            const response = await fetchWithAuth(url);

            // 2. Handle Authentication/Redirects
            // If require_login redirects to a login page, the response.url will change
            if (response.redirected) {
                console.warn("User session expired, redirecting to login page...");
                window.location.href = response.url;
                return [];
            }

            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }

            // 3. Parse JSON result
            const users = await response.json();
            return users;

        } catch (error) {
            console.error("Error fetching namespace users:", error);
            return [];
        }
    }

    async function fetchItems() {
        const apikeys_resp = await fetchWithAuth('/demo/generate_apikeys');
        const apikeys = await apikeys_resp.json();
        const apikey_tbody = document.querySelector('#items-table tbody');
        apikey_tbody.innerHTML = '';
        apikeys.forEach(key => {
            const row = document.createElement('tr');
            const created = formatLocalDateTime(key.createtime);
            const expires = formatLocalDateTime(key.expires_at);
            const rawKey = key.apikey || '';
            const maskedRawKey = maskApikey(rawKey);
            const rawKeyCell = rawKey
                ? `<span class="apikey-raw-value" data-apikey="${rawKey}">${maskedRawKey}</span><button type="button" class="apikey-copy-cell-btn" data-tooltip="Copy key" aria-label="Copy key" onclick="copyApikeyFromRow(this)"><svg viewBox="0 0 24 24" aria-hidden="true"><rect x="9" y="9" width="10" height="10"></rect><rect x="5" y="5" width="10" height="10"></rect></svg></button>`
                : '';
            row.innerHTML = `
                <td style="text-align: center;"><input type="checkbox" data-keyname="${key.keyname}" data-username="${key.username}" onchange="updateDeleteApikeyButtonState()"></td>
                <td style="text-align: center;">${key.keyname}</td>
                <td style="text-align: center;">${key.username}</td>
                <td style="text-align: center;">${rawKeyCell}</td>
                <td style="text-align: center;">${key.access_level || key.scope || ''}</td>
                <td style="text-align: center;">${key.restrict_tenant || ''}</td>
                <td style="text-align: center;">${key.restrict_namespace || ''}</td>
                <td style="text-align: center;">${created}</td>
                <td style="text-align: center;">${expires}</td>
            `;
            apikey_tbody.appendChild(row);
        });
        updateDeleteApikeyButtonState();

        const tenant_dropdown = document.getElementById("tenant_dropdown");
        const namespace_dropdown = document.getElementById("namespace_dropdown");
        const namespaceCreateCard = document.getElementById("namespace-create-card");
        const namespaceTenantSelectField = document.getElementById("namespace-tenant-select-field");
        const namespaceTenantReadonlyField = document.getElementById("namespace-tenant-readonly-field");
        const namespaceTenantReadonlyValue = document.getElementById("namespace-tenant-readonly-value");
        const apikeyRestrictTenantSelect = document.getElementById("apikey_restrict_tenant");
        const apikeyRestrictNamespaceSelect = document.getElementById("apikey_restrict_namespace");
        const apikeyTenantChoices = new Set();
        const apikeyNamespaceChoices = {};
        const namespaceCreateTenantChoices = [];

        if (tenant_dropdown) {
            tenant_dropdown.innerHTML = '';
            const placeholderOption = document.createElement("option");
            placeholderOption.disabled = true;
            placeholderOption.selected = true;
            placeholderOption.textContent = "Select a tenant";
            tenant_dropdown.appendChild(placeholderOption);
        }

        const roles_resp = await fetchWithAuth('/demo/generate_roles');
        const roles = await roles_resp.json();

        // Target both table bodies
        const tenant_tbody = document.querySelector('#tenant-roles-table tbody');
        const namespace_tbody = document.querySelector('#namespace-roles-table tbody');

        const consolidated = roles.reduce((acc, curr) => {
            const type = String(curr.objType).toLowerCase();
            // Create a unique key for grouping
            const key = type === 'tenant' ? curr.tenant : `${curr.tenant}/${curr.namespace}`;

            if (!acc[key]) {
                acc[key] = { ...curr, isAdmin: false, isUser: false };
            }

            const role = String(curr.role).toLowerCase();
            if (role === 'admin') acc[key].isAdmin = true;
            if (role === 'user') acc[key].isUser = true;

            return acc;
        }, {});

        // Clear existing content
        tenant_tbody.innerHTML = '';
        namespace_tbody.innerHTML = '';

        Object.values(consolidated).forEach(item => {
            const type = String(item.objType).toLowerCase();
            const row = document.createElement('tr');

            // helper to render a checkmark or dash
            const check = (val) => val ? '<span style="color: green; font-weight: bold;">✓</span>' : '<span style="color: #ccc;">-</span>';

            if (type === 'tenant') {
                row.innerHTML = `
            <td style="text-align: center;"><a href="{{ hosturl }}listfunc?tenant=${item.tenant}">${tenantLinkLabelHtml(item.tenant)}</a></td>
            <td style="text-align:center">${check(item.isAdmin)}</td>
            <td style="text-align:center">${check(item.isUser)}</td>
        `;
                tenant_tbody.appendChild(row);
            } else {
                row.innerHTML = `
            <td style="text-align: center;"><a href="{{ hosturl }}listfunc?tenant=${item.tenant}">${tenantLinkLabelHtml(item.tenant)}</a></td>
            <td style="text-align: center;"><a href="{{ hosturl }}listfunc?tenant=${item.tenant}&namespace=${item.namespace}">${item.namespace}</a></td>
            <td style="text-align:center">${check(item.isAdmin)}</td>
            <td style="text-align:center">${check(item.isUser)}</td>
        `;
                namespace_tbody.appendChild(row);
            }
        });

        const funcs_tbody = document.querySelector('#models-table tbody');
        if (funcs_tbody) {
            const funcs_resp = await fetchWithAuth('/demo/generate_funcs');
            const funcs = await funcs_resp.json();
            funcs_tbody.innerHTML = '';
            funcs.forEach(key => {
                const isAdmin = IsAdmin(roles, key.func.tenant, key.func.namespace);
                const isUser = IsUser(roles, key.func.tenant, key.func.namespace);

                if (isAdmin || isUser) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td style="text-align: center;">
                        <input type="checkbox" 
                            data-id="${key.tenant}/system/${key.name}"
                            ${!isAdmin ? 'disabled' : ''} 
                            style="${!isAdmin ? 'cursor: not-allowed; opacity: 0.5;' : 'cursor: pointer;'}">
                    </td>
                    <td style="text-align: center;">
                        <a href="{{ hosturl }}listfunc?tenant=${key.func.tenant}">
                            ${tenantLinkLabelHtml(key.func.tenant)}
                        </a>
                    </td>
                    <td style="text-align: center;">
                        <a
                            href="{{ hosturl }}listfunc?tenant=${key.func.tenant}&&namespace=${key.func.namespace}">
                            ${key.func.namespace}
                        </a>
                    </td>
                    <td style="text-align: center;">
                        <a
                            href="{{ hosturl }}func?tenant=${key.func.tenant}&&namespace=${key.func.namespace}&&name=${key.func.name}">
                            ${key.func.name}
                        </a>
                    </td>
                    <td style="text-align: center;">${isAdmin
                            ? '<span style="color: green; font-weight: bold;">✓</span>'
                            : '<span style="color: #666;">-</span>'}
                    </td>
                    <td style="text-align: center;">${isUser
                            ? '<span style="color: green; font-weight: bold;">✓</span>'
                            : '<span style="color: #666;">-</span>'}
                    </td>
                `;
                    funcs_tbody.appendChild(row);
                }
            });
        }


        const namespaces_resp = await fetchWithAuth('/demo/generate_namespaces');
        const namespaces = await namespaces_resp.json();
        const namespaces_tbody = document.querySelector('#namespaces-table tbody');
        namespaces_tbody.innerHTML = '';
        for (const key of namespaces) {
            const row = document.createElement('tr');
            const isAdmin = IsAdmin(roles, key.tenant, key.name);
            const isUser = IsUser(roles, key.tenant, key.name);

            if (isAdmin || isUser) {
                apikeyTenantChoices.add(key.tenant);
                if (!apikeyNamespaceChoices[key.tenant]) {
                    apikeyNamespaceChoices[key.tenant] = new Set();
                }
                apikeyNamespaceChoices[key.tenant].add(key.name);
            }

            const adminList = await getNamespaceUsers("admin", key.tenant, key.name);
            const userList = await getNamespaceUsers("user", key.tenant, key.name);

            const adminNames = adminList.length > 0 ? adminList.join(', ') : '-';
            const userNames = userList.length > 0 ? userList.join(', ') : '-';

            row.innerHTML = `
                <td style="text-align: center; vertical-align: middle;">
                    <input type="checkbox" 
                        data-id="${key.tenant}/system/${key.name}"
                        ${!isAdmin ? 'disabled' : ''} 
                        style="${!isAdmin ? 'cursor: not-allowed; opacity: 0.5;' : 'cursor: pointer;'}">
                </td>
                <td style="text-align: center; vertical-align: middle;">
                    <a href="{{ hosturl }}listfunc?tenant=${key.tenant}">
                        ${tenantLinkLabelHtml(key.tenant)}
                    </a>
                </td>
                <td style="text-align: center;">
                    <a
                        href="{{ hosturl }}listfunc?tenant=${key.tenant}&&namespace=${key.name}">
                        ${key.name}
                    </a>
                </td>
                <td style="text-align: center;">${isAdmin
                    ? '<span style="color: green; font-weight: bold;">✓</span>'
                    : '<span style="color: #666;">-</span>'}
                </td>
                <td style="text-align: center;">${isUser
                    ? '<span style="color: green; font-weight: bold;">✓</span>'
                    : '<span style="color: #666;">-</span>'}
                </td>
                <td style="text-align: center; font-size: 0.9em; color: #555;">${adminNames}</td>
                <td style="text-align: center; font-size: 0.9em; color: #555;">${userNames}</td>
           `;
            namespaces_tbody.appendChild(row);

            if (isAdmin && namespace_dropdown) {
                const option = document.createElement("option");
                option.value = key.tenant + "/" + key.name;
                option.textContent = `${tenantDisplayLabel(key.tenant)}/${key.name}`;
                namespace_dropdown.appendChild(option);
            }

        };

        const tenants_resp = await fetchWithAuth('/demo/generate_tenants');
        const tenants = await tenants_resp.json();
        upsertTenantDisplayMapFromList(tenants);
        const tenants_tbody = document.querySelector('#tenants-table tbody');
        tenants_tbody.innerHTML = '';
        for (const key of tenants) {
            const row = document.createElement('tr');
            const isAdmin = IsAdmin(roles, key.name, "");
            const isUser = IsUser(roles, key.name, "");

            if (isAdmin || isUser) {
                apikeyTenantChoices.add(key.name);
            }

            const adminList = await getTenantUsers("admin", key.name);
            const userList = await getTenantUsers("user", key.name);

            const adminNames = adminList.length > 0 ? adminList.join(', ') : '-';
            const userNames = userList.length > 0 ? userList.join(', ') : '-';

            row.innerHTML = `
                <td style="text-align: center; vertical-align: middle;">
                    <a
                        href="{{ hosturl }}listfunc?tenant=${key.name}">
                        ${tenantLinkLabelHtml(key.name)}
                    </a>
                </td>
                <td style="text-align: center;">${isAdmin
                    ? '<span style="color: green; font-weight: bold;">✓</span>'
                    : '<span style="color: #666;">-</span>'}
                </td>
                <td style="text-align: center;">${isUser
                    ? '<span style="color: green; font-weight: bold;">✓</span>'
                    : '<span style="color: #666;">-</span>'}
                </td>
                <td style="text-align: center; font-size: 0.9em; color: #555;">${adminNames}</td>
                <td style="text-align: center; font-size: 0.9em; color: #555;">${userNames}</td>
                
            `;
            tenants_tbody.appendChild(row);

            if (isAdmin) {
                namespaceCreateTenantChoices.push(key.name);
                const option = document.createElement("option");
                option.value = key.name;
                option.textContent = tenantDisplayLabel(key.name);
                tenant_dropdown.appendChild(option);
            }
        };

        if (namespaceCreateCard && tenant_dropdown) {
            if (namespaceCreateTenantChoices.length === 0) {
                namespaceCreateCard.style.display = "none";
            } else if (namespaceCreateTenantChoices.length === 1) {
                const onlyTenant = namespaceCreateTenantChoices[0];
                tenant_dropdown.value = onlyTenant;
                namespaceCreateCard.style.display = "";
                if (namespaceTenantSelectField) namespaceTenantSelectField.style.display = "none";
                if (namespaceTenantReadonlyField) namespaceTenantReadonlyField.style.display = "";
                if (namespaceTenantReadonlyValue) {
                    namespaceTenantReadonlyValue.textContent = tenantDisplayLabel(onlyTenant);
                }
            } else {
                namespaceCreateCard.style.display = "";
                tenant_dropdown.selectedIndex = 0;
                if (namespaceTenantSelectField) namespaceTenantSelectField.style.display = "";
                if (namespaceTenantReadonlyField) namespaceTenantReadonlyField.style.display = "none";
                if (namespaceTenantReadonlyValue) namespaceTenantReadonlyValue.textContent = "";
            }
        }

        // Populate API key restriction tenant/namespace dropdowns.
        if (apikeyRestrictTenantSelect && apikeyRestrictNamespaceSelect) {
            const prevTenant = apikeyRestrictTenantSelect.value;
            setSelectDefaultOption(apikeyRestrictTenantSelect, 'Select tenant');

            const tenantList = Array.from(apikeyTenantChoices).sort((a, b) => a.localeCompare(b));
            tenantList.forEach(tenant => {
                const option = document.createElement('option');
                option.value = tenant;
                option.textContent = tenantDisplayLabel(tenant);
                apikeyRestrictTenantSelect.appendChild(option);
            });

            apikeyRestrictNamespacesByTenant = {};
            Object.keys(apikeyNamespaceChoices).forEach(tenant => {
                apikeyRestrictNamespacesByTenant[tenant] = Array.from(apikeyNamespaceChoices[tenant])
                    .sort((a, b) => a.localeCompare(b));
            });

            if (prevTenant && tenantList.includes(prevTenant)) {
                apikeyRestrictTenantSelect.value = prevTenant;
            }

            onApikeyRestrictTenantChange();
        }
        configureApikeyCreateForm(roles);
        if (window.applyTenantDisplayNames) {
            window.applyTenantDisplayNames(document);
        }
    }

    async function create_func() {
        var access_token = "{{ session['token'] }}";
        const namespace_dropdown = document.getElementById("namespace_dropdown");
        const isSelected = namespace_dropdown.selectedIndex !== -1;
        if (!isSelected) {
            alert("need choose a namespace");
            return
        }

        const namespacekey = namespace_dropdown.value;

        const parts = namespacekey.split("/");
        const tenant = parts[0];     // "tenant"
        const namespace = parts[1];  // "namespace"

        const modelname = document.getElementById("model_name").value.trim();
        if (!modelname) {
            alert("need valid model name");
            return
        }

        const hostname = window.location.hostname;
        const port = window.location.port;
        const schema = window.location.protocol;

        url = schema + "//" + hostname + ":" + port + "/demo/proxy1/object/";

        const model_spec = document.getElementById('model_spec').value.trim();
        if (!model_spec) {
            alert("need valid model spec");
            return
        }

        try {
            const options = {
                method: 'PUT',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "type": "function",
                    "tenant": tenant,
                    "namespace": namespace,
                    "name": modelname,
                    "object": {
                        "spec": JSON.parse(model_spec)
                    }
                })
            };

            const response = await fetchWithAuth("/demo/proxy/object/", options);
            const text = await response.text();
            if (response.status == '200') {
                alert("Create Model successfully! " + text);
            } else {
                alert("Create Model fail with error" + text);
            }
            // nameInput.value = '';
            // fetchItems();
        } catch (error) {
            // always get to error here but create func successfully
            // todo: debug this.
            // alert("get error " + error);

        }
    }

    async function delete_funcs() {
        var access_token = "{{ session['token'] }}";
        try {
            const checkboxes = document.querySelectorAll('#models-table tbody input[type="checkbox"]:checked');
            const keys = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
            if (keys.length > 0) {
                await Promise.all(keys.map(key => {
                    fetchWithAuth('/demo/proxy/object/function/' + key + "/", {
                        method: 'DELETE'
                    });
                }));
            }
        } catch (error) {
            alert("get error " + error);
        }
    }

    async function create_namespace() {
        const tenant_dropdown = document.getElementById("tenant_dropdown");
        const isSelected = tenant_dropdown.selectedIndex !== -1;
        if (!isSelected) {
            alert("need choose a tenant");
            return
        }

        const tenant = tenant_dropdown.value;
        if (!tenant || tenant == "Select a tenant") {
            alert("need choose a tenant");
            return
        }

        const namespacename = document.getElementById("namespace_name").value.trim();
        if (!namespacename) {
            alert("need valid namespace name");
            return
        }

        const hostname = window.location.hostname;
        const port = window.location.port;
        const schema = window.location.protocol;

        url = schema + "//" + hostname + ":" + port + "/demo/proxy1/object/";
        // url = "http://192.168.0.22:1250/proxy/object/";

        try {
            const options = {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "type": "namespace",
                    "tenant": tenant,
                    "namespace": "system",
                    "name": namespacename,
                    "object": {
                        "spec": {},
                        "status": {
                            "disable": false
                        }
                    }
                })
            };

            const apikeys_resp = await fetchWithAuth("/demo/proxy/object/", options);
            const text = await apikeys_resp.text();

            if (apikeys_resp.status === 200) {
                alert("Create Namespace successfully! ");
            } else {
                alert("Create Namespace fail with error" + text);
            }
        } catch (error) {
            // always get to error here but create func successfully
            // todo: debug this.
            // alert("Create Namespace get error " + error);
        }
    }

    async function delete_namespaces() {
        try {
            const checkboxes = document.querySelectorAll('#namespaces-table tbody input[type="checkbox"]:checked');
            const keys = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
            if (keys.length > 0) {
                await Promise.all(keys.map(key => {
                    fetchWithAuth('/demo/proxy/object/namespace/' + key + "/", {
                        method: 'DELETE'
                    });
                }));
            }
        } catch (error) {
            alert("get error " + error);
        }
    }

    async function create_tenant() {
        const tenant_name = document.getElementById("tenant_name").value.trim();
        if (!tenant_name) {
            alert("need valid namespace name");
            return
        }

        const hostname = window.location.hostname;
        const port = window.location.port;
        const schema = window.location.protocol;

        url = schema + "//" + hostname + ":" + port + "/demo/proxy1/object/";
        // url = "http://192.168.0.22:1250/proxy/object/";

        try {
            const options = {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "type": "tenant",
                    "tenant": "system",
                    "namespace": "system",
                    "name": tenant_name,
                    "object": {
                        "spec": {},
                        "status": {
                            "disable": false
                        }
                    }
                })
            };

            const resp = await fetchWithAuth("/demo/proxy/object/", options);
            const text = await resp.text();

            if (resp.status === 200) {
                alert("Create Tenant successfully! ");
            } else {
                alert("Create Tenant fail with error" + text);
            }
        } catch (error) {
            // always get to error here but create func successfully
            // todo: debug this.
            // alert("Create Namespace get error " + error);
        }
    }

    async function delete_tenants() {
        try {
            const checkboxes = document.querySelectorAll('#tenants-table tbody input[type="checkbox"]:checked');
            const keys = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
            if (keys.length > 0) {
                await Promise.all(keys.map(key => {
                    fetchWithAuth('/demo/proxy/object/tenant/' + key + "/", {
                        method: 'DELETE'
                    });
                }));
            }
        } catch (error) {
            alert("get error " + error);
        }
    }

    async function create_apikey() {
        const nameInput = document.getElementById('apikey_name');
        const keyname = nameInput.value.trim();
        if (!keyname) {
            alert("Please enter an API key name.");
            if (nameInput && typeof nameInput.focus === 'function') {
                nameInput.focus();
            }
            return;
        }

        const accessLevel = document.getElementById('apikey_access_level').value;
        const restrictTenant = document.getElementById('apikey_restrict_tenant').value.trim();
        const restrictNamespace = document.getElementById('apikey_restrict_namespace').value.trim();
        const expiresDays = document.getElementById('apikey_expires_days').value;
        if (!apikeyCreatorIsInferxAdmin && !restrictTenant) {
            alert("Please select a tenant for this API key.");
            return;
        }

        const payload = {
            "username": "",
            "keyname": keyname
        };
        if (apikeyCreatorIsInferxAdmin) {
            payload.access_level = "full";
            payload.restrict_tenant = "system";
        } else {
            payload.access_level = accessLevel;
            payload.restrict_tenant = restrictTenant;
            if (restrictNamespace) payload.restrict_namespace = restrictNamespace;
        }
        if (expiresDays) payload.expires_in_days = parseInt(expiresDays);

        try {
            const resp = await fetchWithAuth("/demo/apikeys", {
                method: 'PUT',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            if (resp.ok) {
                const result = await resp.json();
                showApikeyModal(result);
                nameInput.value = '';
                document.getElementById('apikey_expires_days').value = '';
                if (apikeyCreatorIsInferxAdmin) {
                    const namespaceSelect = document.getElementById('apikey_restrict_namespace');
                    document.getElementById('apikey_restrict_tenant').value = 'system';
                    document.getElementById('apikey_access_level').value = 'full';
                    setSelectDefaultOption(namespaceSelect, '(not used)');
                    if (namespaceSelect) namespaceSelect.disabled = true;
                } else {
                    document.getElementById('apikey_restrict_tenant').value = '';
                    onApikeyRestrictTenantChange();
                    document.getElementById('apikey_access_level').value = 'inference';
                }
                fetchItems();
            } else {
                const errText = await resp.text();
                alert("Failed to create API key: " + mapCreateApikeyError(errText, keyname));
            }
        } catch (error) {
            alert("Error creating API key: " + error);
        }
    }

    function mapCreateApikeyError(errText, keyname) {
        const text = String(errText || '');
        if (text.includes('restrict_tenant is required')) {
            return 'Tenant is required for API key creation.';
        }
        if (text.includes('restrict_tenant cannot be empty')) {
            return 'Tenant is required for API key creation.';
        }
        const isDuplicateName = text.includes('duplicate key value violates unique constraint') &&
            (text.includes('(username, keyname)=') ||
             text.includes('apikey_idx_username_keyname') ||
             text.includes('apikey_idx_realm_username'));

        if (isDuplicateName) {
            return `API key name '${keyname}' already exists. Please choose a different key name.`;
        }

        return text;
    }

    function showApikeyModal(result) {
        document.getElementById('apikey-modal-value').textContent = result.apikey;
        document.getElementById('apikey-modal-access-level').textContent = result.access_level || result.scope || '';
        if (result.expires_at) {
            document.getElementById('apikey-modal-expires').textContent = formatLocalDateTime(result.expires_at);
            document.getElementById('apikey-modal-expires-wrap').style.display = 'inline';
        } else {
            document.getElementById('apikey-modal-expires-wrap').style.display = 'none';
        }
        document.getElementById('apikey-modal').style.display = 'flex';
    }

    function closeApikeyModal() {
        document.getElementById('apikey-modal').style.display = 'none';
    }

    function copyApikeyToClipboard() {
        const key = document.getElementById('apikey-modal-value').textContent;
        copyTextToClipboard(key).then(copied => {
            if (copied) {
                alert('API key copied to clipboard');
            } else {
                alert('Failed to copy API key');
            }
        });
    }

    async function delete_apikeys() {
        try {
            const checkboxes = document.querySelectorAll('#items-table tbody input[type="checkbox"]:checked');
            if (checkboxes.length === 0) return;

            if (!confirm(`Delete ${checkboxes.length} selected API key(s)?`)) return;

            await Promise.all(Array.from(checkboxes).map(cb => {
                return fetchWithAuth("/demo/apikeys", {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        "username": cb.getAttribute('data-username'),
                        "keyname": cb.getAttribute('data-keyname')
                    })
                });
            }));

            fetchItems();
        } catch (error) {
            // output.innerHTML += error + '<br>';
            // output.innerHTML += error.cause + '<br>';

        }
    }

    // Initial fetch
    fetchItems();
</script>

{{ hosturl }}
{% endblock %}
