{% extends 'base.html' %}

{% block content %}
<style>
    .content table.ix-table {
        font-size: 14px;
    }

    .models-table {
        table-layout: fixed;
    }

    .models-table th,
    .models-table td {
        white-space: normal;
        overflow-wrap: anywhere;
        word-break: break-word;
    }

    .models-table a {
        overflow-wrap: anywhere;
        word-break: break-word;
    }

    .func-list-toolbar {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }

    .func-list-actions {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .ix-btn {
        display: inline-block;
        border: 1px solid #2563eb;
        background: #2563eb;
        color: #fff;
        border-radius: 4px;
        padding: 8px 12px;
        text-decoration: none;
        cursor: pointer;
        font-size: 14px;
    }

    .ix-btn.secondary {
        background: #fff;
        color: #1e3a8a;
        border-color: #93c5fd;
    }

    .ix-btn.danger {
        background: #b91c1c;
        border-color: #b91c1c;
    }

    .ix-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .row-actions {
        display: inline-flex;
        gap: 6px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .row-actions a {
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 4px;
        border: 1px solid #cbd5e1;
        text-decoration: none;
        color: #1f2937;
        background: #fff;
    }

    .row-actions a:hover {
        background: #eff6ff;
        border-color: #93c5fd;
    }

    #delete-status {
        margin-top: 8px;
        font-size: 13px;
        min-height: 18px;
    }

    #delete-status.error {
        color: #b91c1c;
    }

    #delete-status.success {
        color: #166534;
    }
</style>

{% if can_manage_models %}
<div class="func-list-toolbar">
    <div class="func-list-actions">
        <a class="ix-btn" href="{{ hosturl }}func_create">+ Create Model</a>
    </div>
</div>
{% endif %}

<table class="ix-table models-table" style="width:100%; text-align: center;">
    <thead>
        <tr>
            <th rowspan="2" style="width: 42px;">
                <input id="select-all-models" type="checkbox" aria-label="Select all models" {% if not can_manage_models %}disabled aria-disabled="true"{% endif %}>
            </th>
            <th rowspan="2">Tenant</th>
            <th rowspan="2">Namespace</th>
            <th rowspan="2">Model Name</th>
            <th rowspan="2">Type</th>
            <th rowspan="2">GPU Count</th>
            <th rowspan="2">vRam (GB)</th>
            <th rowspan="2">CPU</th>
            <th rowspan="2">Memory (GB)</th>
            <th colspan="3">Standby</th>
            <th rowspan="2">State</th>
            <th rowspan="2">Snapshot Nodes</th>
            <th rowspan="2">Revision</th>
            <th rowspan="2">Actions</th>
        </tr>
        <tr>
            <th>GPU</th>
            <th>Pageable</th>
            <th>Pinned</th>
        </tr>
    </thead>
    <tbody>
        {% for func in funcs %}
        {% set tenant = func['func']['tenant'] %}
        {% set namespace = func['func']['namespace'] %}
        {% set name = func['func']['name'] %}
        {% set spec = func['func']['object']['spec'] %}
        {% set row_can_manage = func.get('can_edit_delete', false) %}
        <tr>
            <td>
                <input
                    class="model-select"
                    type="checkbox"
                    data-id="{{ tenant }}/{{ namespace }}/{{ name }}"
                    data-tenant="{{ tenant }}"
                    data-namespace="{{ namespace }}"
                    data-name="{{ name }}"
                    aria-label="Select model {{ name }}"
                    {% if not row_can_manage %}disabled aria-disabled="true" title="No permission to edit/delete this model" style="cursor: not-allowed; opacity: 0.5;"{% endif %}>
            </td>
            <td>
                <a href="{{ hosturl }}listfunc?tenant={{ tenant }}">
                    <span data-tenant-name="{{ tenant }}">{{ tenant }}</span>
                </a>
            </td>
            <td>
                <a href="{{ hosturl }}listfunc?tenant={{ tenant }}&&namespace={{ namespace }}">
                    {{ namespace }}
                </a>
            </td>
            <td>
                <a href="{{ hosturl }}func?tenant={{ tenant }}&&namespace={{ namespace }}&&name={{ name }}">
                    {{ name }}
                </a>
            </td>
            <td>
                {% if spec["sample_query"]["apiType"] == "openai" %}
                text2text
                {% else %}
                {{ spec["sample_query"]["apiType"] }}
                {% endif %}
            </td>
            <td>{{ spec["resources"]["GPU"]["Count"] }}</td>
            <td>{{ spec["resources"]["GPU"]["vRam"]/1000 }}</td>
            <td>{{ spec["resources"]["CPU"]/1000 }}</td>
            <td>{{ spec["resources"]["Mem"]/1000 }}</td>
            <td>{{ spec["standby"]["gpu"] }}</td>
            <td>{{ spec["standby"]["pageable"] }}</td>
            <td>{{ spec["standby"]["pinned"] }}</td>
            <td>{{ func['func']['object']["status"]["state"] }}</td>
            <td>{{ func['snapshotNodes'] }}</td>
            <td>{{ spec["version"] }}</td>
            <td>
                <span class="row-actions">
                    <a href="{{ hosturl }}func?tenant={{ tenant }}&&namespace={{ namespace }}&&name={{ name }}">Open</a>
                    {% if row_can_manage %}
                    <a href="{{ hosturl }}func_create?edit={{ tenant }}/{{ namespace }}/{{ name }}">Edit</a>
                    {% endif %}
                </span>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if can_manage_models %}
<div style="margin-top: 12px; display: flex; align-items: center; gap: 8px;">
    <button id="delete-selected-btn" type="button" class="ix-btn danger">
        Delete Selected
    </button>
</div>
<div id="delete-status" aria-live="polite"></div>
{% endif %}

<h2 style="text-align: center;">Summary</h2>

<table class="ix-table" style="width: 500px; margin: auto; text-align: center;">
    <tr>
        <td width="200"><h3>Model Count</h3></td>
        <td width="200"><h3>{{ summary["model_count"] }}</h3></td>
    </tr>
    <tr>
        <td><h3>Required GPU Count</h3></td>
        <td><h3>{{ summary["gpucount"] }}</h3></td>
    </tr>
    <tr>
        <td><h3>Required VRAM (GB)</h3></td>
        <td><h3>{{ summary["vram"] / 1000 }} GB</h3></td>
    </tr>
    <tr>
        <td><h3>Required CPU Cores</h3></td>
        <td><h3>{{ summary["cpu"] / 1000 }}</h3></td>
    </tr>
    <tr>
        <td><h3>Required Memory (GB)</h3></td>
        <td><h3>{{ summary["memory"] / 1000 }} GB</h3></td>
    </tr>
</table>

<script>
    (function () {
        const selectAll = document.getElementById('select-all-models');
        const deleteBtn = document.getElementById('delete-selected-btn');
        const statusEl = document.getElementById('delete-status');

        function selectableBoxes() {
            return Array.from(document.querySelectorAll('.model-select:not(:disabled)'));
        }

        function selectedRows() {
            return Array.from(document.querySelectorAll('.model-select:not(:disabled):checked'));
        }

        function syncDeleteButtonState() {
            if (!deleteBtn) {
                return;
            }
            deleteBtn.disabled = selectedRows().length === 0;
        }

        function setStatus(message, kind) {
            statusEl.textContent = message || '';
            statusEl.className = kind ? kind : '';
        }

        function syncSelectAll() {
            if (!selectAll) {
                syncDeleteButtonState();
                return;
            }
            const boxes = selectableBoxes();
            if (boxes.length === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
                selectAll.disabled = true;
                syncDeleteButtonState();
                return;
            }
            selectAll.disabled = false;
            const checked = boxes.filter((box) => box.checked).length;
            selectAll.checked = checked === boxes.length;
            selectAll.indeterminate = checked > 0 && checked < boxes.length;
            syncDeleteButtonState();
        }

        selectAll?.addEventListener('change', () => {
            const boxes = selectableBoxes();
            boxes.forEach((box) => {
                box.checked = selectAll.checked;
            });
            syncSelectAll();
        });

        document.querySelectorAll('.model-select').forEach((box) => {
            box.addEventListener('change', syncSelectAll);
        });

        deleteBtn?.addEventListener('click', async () => {
            const rows = selectedRows();
            if (rows.length === 0) {
                setStatus('Select at least one model to delete.', 'error');
                return;
            }

            const names = rows.map((row) => row.dataset.id);
            if (!window.confirm(`Delete ${rows.length} model(s)?\n\n${names.join('\n')}`)) {
                return;
            }

            deleteBtn.disabled = true;
            setStatus('Deleting selected models...', '');

            const failures = [];
            for (const row of rows) {
                const tenant = encodeURIComponent(row.dataset.tenant || '');
                const namespace = encodeURIComponent(row.dataset.namespace || '');
                const name = encodeURIComponent(row.dataset.name || '');
                try {
                    const resp = await fetch(`/demo/proxy/object/function/${tenant}/${namespace}/${name}/`, {
                        method: 'DELETE',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    if (!resp.ok) {
                        const text = await resp.text();
                        failures.push(`${row.dataset.id}: HTTP ${resp.status} ${text}`);
                    }
                } catch (err) {
                    failures.push(`${row.dataset.id}: ${err}`);
                }
            }

            deleteBtn.disabled = false;

            if (failures.length > 0) {
                setStatus(`Delete completed with ${failures.length} failure(s). ${failures[0]}`, 'error');
                return;
            }

            setStatus(`Deleted ${rows.length} model(s). Reloading...`, 'success');
            window.location.reload();
        });

        syncSelectAll();
        syncDeleteButtonState();
    })();
</script>
{% endblock %}
